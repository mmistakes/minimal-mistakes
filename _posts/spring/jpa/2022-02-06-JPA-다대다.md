---
layout: single
title: "[JPA] ë‹¤ëŒ€ë‹¤[N:M] ì—°ê´€ê´€ê³„ ë§¤í•‘"
date: "2022-02-06 06:20:53"
categories: JPA
tag: [JPA, hibernate]
toc: true
author_profile: true
# sidebar:
#   nav: "docs"
---

## ğŸ“Œ ë‹¤ëŒ€ë‹¤ [N:M]

## âœ” ëª©ì°¨

- ì—°ê´€ê´€ê³„ ë§¤í•‘ì‹œ ê³ ë ¤ì‚¬í•­ 3ê°€ì§€
- ë‹¤ëŒ€ì¼ [N:1]
- ì¼ëŒ€ë‹¤ [1:N]
- ì¼ëŒ€ì¼ [1:1]
- **ë‹¤ëŒ€ë‹¤** [N:M] ğŸš€
- ì‹¤ì „ ì˜ˆì œ - 3. ë‹¤ì–‘í•œ ì—°ê´€ê´€ê³„ ë§¤í•‘

## âœ” ë‹¤ëŒ€ë‹¤ [N:M]

### âœ… ë‹¤ëŒ€ë‹¤ ê´€ê³„: í…Œì´ë¸”

<img src="https://user-images.githubusercontent.com/53969142/152667717-6c1c1aae-240e-4747-936f-de32c183569f.PNG" width="90%" height="100%">

- <u class="custom-border-bottom">ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ëŠ” 2ê°œì˜ ì •ê·œí™”ëœ í…Œì´ë¸”ë¡œ ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ í‘œí˜„í•  ìˆ˜ ì—†ë‹¤.</u>
- ë‹¤ëŒ€ë‹¤ ê´€ê³„ëŠ” ì—°ê²° í…Œì´ë¸”ì„ ì¶”ê°€í•´ì„œ <u class="custom-border-bottom">ì¼ëŒ€ë‹¤, ë‹¤ëŒ€ì¼ ê´€ê³„ë¡œ í’€ì–´ì•¼í•œë‹¤.</u>
  - ì¤‘ê°„ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ ê´€ê³„ë¥¼ ì—°ê²°í•œë‹¤.

### âœ… ë‹¤ëŒ€ë‹¤ ê´€ê³„: ê°ì²´

<img src="https://user-images.githubusercontent.com/53969142/152667901-e4e00e9f-50dd-4632-ad1d-eded2edd2a7a.PNG" width="90%" height="100%">

- <u class="custom-border-bottom">ê°ì²´ëŠ” ì»¬ë ‰ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ê°ì²´ 2ê°œë¡œ ë‹¤ëŒ€ë‹¤ ê´€ê³„ í‘œí˜„ì´ ê°€ëŠ¥í•˜ë‹¤.</u>

```java
@Entity
@Table(name = "MEMBER")
public class Member {

    @Id
    @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;

    @ManyToMany
    @JoinTable(name = "MEMBER_PRODUCT")
    private List<Product> products = new ArrayList<>();
    //.. ì¤‘ëµ
}
```

```java
@Entity
@Table(name = "PRODUCT")
public class Product {

    @Id
    @GeneratedValue
    @Column(name = "PRODUCT_ID")
    private Long id;

    private String name;

    /* Member Entityì˜ products ê°ì²´ ì°¸ì¡° */
    @ManyToMany(mappedBy = "products")
    private List<Member> members = new ArrayList<>();
    //.. ì¤‘ëµ
}
```

```sql
Hibernate:

    create table Member (
       MEMBER_ID bigint not null,
        USERNAME varchar(255),
        LOCKER_ID bigint,
        TEAM_ID bigint,
        primary key (MEMBER_ID)
    )
Hibernate:

    create table MEMBER_PRODUCT (
       Member_MEMBER_ID bigint not null,
        products_id bigint not null
    )
Hibernate:

    create table Product (
       id bigint not null,
        name varchar(255),
        primary key (id)
    )

Hibernate:

    alter table MEMBER_PRODUCT
       add constraint FKl133ngpiayquuf2cu1njdq5hy
       foreign key (products_id)
       references Product
Hibernate:

    alter table MEMBER_PRODUCT
       add constraint FK10kgxdeb5bnrb5vonj4x9qtir
       foreign key (Member_MEMBER_ID)
       references Member
```

- Member ê°ì²´ë„ **List<Product>**ë¥¼ ê°€ì§€ê³ , Product ê°ì²´ë„ **List<Member>** ê°€ì§ˆ ìˆ˜ ìˆë‹¤.
- ë˜í•œ ìœ„ ì‚¬ì§„ì„ ë³´ë©´ MEMBER_PRODUCTê°€ ìƒì„±ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
  - foreign key (products_id), foreign key (Member_MEMBER_ID) ì£¼ëª©.

### âœ… ë‹¤ëŒ€ë‹¤ ê´€ê³„ @ì–´ë…¸í…Œì´ì…˜

- **@ManyToMany** ì‚¬ìš©
- **@JoinTable**ë¡œ ì—°ê²° í…Œì´ë¸” ì§€ì •
- ë‹¤ëŒ€ë‹¤ ë§¤í•‘
  - **ë‹¨ë°©í–¥**, **ì–‘ë°©í–¥** ë‘˜ ë‹¤ ê°€ëŠ¥

### âŒ ë‹¤ëŒ€ë‹¤ ë§¤í•‘ì˜ í•œê³„

<img src="https://user-images.githubusercontent.com/53969142/152668287-ca970e05-aec9-4a02-88e9-7b7683d0b53a.PNG" width="100%" height="200px">

- <u class="custom-border-bottom">í¸ë¦¬í•´ ë³´ì´ì§€ë§Œ ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ê²ƒì´ ì•„ë‹ˆë‹¤.</u>
- ì—°ê²° í…Œì´ë¸”ì´ ë‹¨ìˆœíˆ ì—°ê²°ë§Œí•˜ê³  ëë‚˜ì§€ ì•ŠëŠ”ë‹¤.
- ì£¼ë¬¸ì‹œê°„, ìˆ˜ëŸ‰ ê°™ì€ ë°ì´í„°ê°€ ë“¤ì–´ì˜¬ ìˆ˜ ìˆìŒ.
  - ì¦‰, ì›í•˜ëŠ” ì •ë³´ê°€ ì•„ë‹Œ ì¶”ê°€ì ì¸ ì •ë³´ê°€ ë“¤ì–´ê°ˆ ìˆ˜ ìˆë‹¤.
  - ì¿¼ë¦¬ê°€ ì´ìƒí•˜ê²Œ ë‚˜ê°€ëŠ” í˜„ìƒì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
- ë‹¤ëŒ€ë‹¤ ì—°ê´€ê´€ê³„ ë§¤í•‘ì€ ì‚¬ìš©ì„ ì§€ì–‘í•˜ëŠ”ê²ƒì„ ì¶”ì²œí•œë‹¤.

### âš”ï¸ ë‹¤ëŒ€ë‹¤ ë§¤í•‘ í•œê³„ ê·¹ë³µ

<img src="https://user-images.githubusercontent.com/53969142/152668579-609e057a-6257-4efd-a506-c304d612abc2.PNG" width="100%" height="100%">

- ì—°ê²° í…Œì´ë¸”ìš© ì—”í‹°í‹°ë¥¼ í•˜ë‚˜ ì¶”ê°€í•œë‹¤(ì—°ê²°í…Œì´ë¸”ì„ ì—”í‹°í‹°ë¡œ ìŠ¹ê²©ì‹œí‚¨ë‹¤)
  - ì¦‰, ORDER ì—”í‹°í‹°(í…Œì´ë¸”)ì„ í•˜ë‚˜ ìƒì„±í•˜ëŠ”ê²ƒì„ ì˜ë¯¸í•œë‹¤.
- @ManyToMany -> @OneToMany, @ManyToOneìœ¼ë¡œ ë³€ê²½í•œë‹¤.

### ğŸ”¨ ë‹¤ëŒ€ë‹¤ ë§¤í•‘ í•œê³„ ê·¹ë³µ ì˜ˆì‹œ

```java
@Entity
public class Member {

    @Id
    @GeneratedValue
    private Long id;

    // Before
    // @ManyToMany
    // @JoinTable(name = "MEMBER_PRODUCT")
    // private List<Product> products = new ArrayList<>();

    // After
    @OneToMany(mappedBy = "member")
    private List<MemberProduct> memberProducts = new ArrayList<>();
    //.. ì¤‘ëµ
}
```

- @ManyToMany -> @OneToManyë¡œ ë³€ê²½í•œë‹¤.
- @JoinTable ì œê±°í•œë‹¤.
- ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì€ MemberProduct í…Œì´ë¸”ì˜ memberê°€ ëœë‹¤.

```java
@Entity
public class Product {

    @Id
    @GeneratedValue
    private Long id;

    // Before
    // @ManyToMany(mappedBy = "products")
    // private List<Member> members = new ArrayList<>();

    // After
    @OneToMany(mappedBy = "product")
    private List<MemberProduct> memberProducts = new ArrayList<>();
    //.. ì¤‘ëµ
}
```

- @ManyToMany -> @OneToManyë¡œ ë³€ê²½í•œë‹¤.
- ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì€ MemberProduct í…Œì´ë¸”ì˜ productê°€ ëœë‹¤.

```java
@Entity
public class MemberProduct {

    @Id
    @GeneratedValue
    private Long id;

    @ManyToOne
    @JoinColumn(name="MEMBER_ID")
    private Member member;

    @ManyToOne
    @JoinColumn(name="PRODUCT_ID")
    private Product product;

    // ì¶”ê°€ì ìœ¼ë¡œ ì»¬ëŸ¼ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
    private int count;
    private int price;

    private LocalDateTime orderDateTime;
}
```

- MemberProduct ì—”í‹°í‹°ë¥¼ í•˜ë‚˜ ìƒì„±í•˜ì—¬ ë‹¤ëŒ€ë‹¤ ì—°ê´€ê´€ê³„ ë§¤í•‘ ì„¤ì •.
- ì¼ëŒ€ë‹¤(1:N), ë‹¤ëŒ€ì¼(N:1) ê´€ê³„ê°€ ì„±ë¦½ëœë‹¤.

### ğŸ’¡ ë‹¤ëŒ€ë‹¤ í•œê³„ ê·¹ë³µ ì •ë¦¬

ì§€ê¸ˆê¹Œì§€ ë‹¤ëŒ€ë‹¤ ì—°ê´€ê´€ê³„ì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸°ìœ„í•œ ì˜ˆì œë¥¼ ì‚´í´ë³´ì•˜ë‹¤. <u class="custom-border-bottom">ì—¬ê¸°ì„œ í•µì‹¬ì€
ê¸°ì¡´ì—ëŠ” ì¤‘ê°„ í…Œì´ë¸”(ì—”í‹°í‹°)ë¥¼ ë§Œë“¤ì§€ ì•Šê³  @JoinTable(name = "MEMBER_PRODUCT")ë¥¼
ì„ ì–¸í•˜ì—¬ ë‹¤ëŒ€ë‹¤ ë§¤í•‘ì„ ì§„í–‰ í•˜ì˜€ëŠ”ë° í˜„ì¬ëŠ” MemberProduct ì—”í‹°í‹°ë¥¼ ì¤‘ê°„ í…Œì´ë¸”ë¡œ ì„¤ì • í•˜ì—¬ ë§¤í•‘í–ˆë‹¤ëŠ” ì°¨ì´ì ì´ ì¡´ì¬í•œë‹¤.</u>

### ğŸš€ ì‹¤ìŠµ

```java
public class JpaMainSample {

    public static void main(String[] args) {
        EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello");
        EntityManager em = emf.createEntityManager();

        EntityTransaction tx = em.getTransaction();
        tx.begin();

        try {
            /* MemberSample */
            MemberSample member = new MemberSample();
            member.setUsername("í…ŒìŠ¤íŠ¸ìœ ì €1");

            em.persist(member); // member ë“±ë¡

            /* Product */
            Product product = new Product();
            product.setName("ì „ìë ˆì¸ì§€");

            em.persist(product); // product ë“±ë¡

            /* MemberProduct */
            MemberProduct memberProduct = new MemberProduct();
            memberProduct.setCount(1);  // ìˆ˜ëŸ‰
            memberProduct.setPrice(50000);  // ê°€ê²©
            memberProduct.setMember(member);    // member ì…‹íŒ…
            memberProduct.setProduct(product);  // product ì…‹íŒ…

            em.persist(memberProduct);
            tx.commit();
        } catch (Exception e) {
            tx.rollback();
        } finally {
            em.close();
        }

        emf.close();
    }
}
```

### ì°¸ê³  ìë£Œ

- [ë‹¤ëŒ€ë‹¤[N:M]](https://www.inflearn.com/course/ORM-JPA-Basic/lecture/21703?tab=curriculum&volume=1.00&quality=1080&speed=1)
