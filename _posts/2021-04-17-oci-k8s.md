---
toc: true
title: "ì˜¤ë¼í´ í´ë¼ìš°ë“œì— ì¿ ë²„ë„¤í‹°ìŠ¤(k3s) ì„¤ì¹˜"
date: 2021-04-17
categories: [ oci,kubernetes,infra ]
---

## ì¸ìŠ¤í„´ìŠ¤ ì¤€ë¹„

### SSH í‚¤ ìƒì„±

ì¶”í›„ ì»´í“¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•˜ê¸° ìœ„í•œ SSH í‚¤ í˜ì–´ë¥¼ ì¤€ë¹„í•´ë‘¡ë‹ˆë‹¤. ì´ë¯¸ ìˆì„ ê²½ìš° ê³µê°œí‚¤ë¥¼ ì¤€ë¹„í•´ë‘ê³  ì—†ì„ ê²½ìš° ì´ [ë§í¬](https://docs.rightscale.com/faq/How_Do_I_Generate_My_Own_SSH_Key_Pair.html)ë¥¼ ì°¸ê³ í•´ì„œ ìƒì„±í•©ë‹ˆë‹¤.

## ì»´í“¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

### ì»´í“¨íŠ¸ ë©”ë‰´ ì§„ì…

![Create instance](https://raw.githubusercontent.com/urunimi/urunimi.github.io/master/_posts/2021-04-17-oci-k8s/oci-1.png)

- Compute ì„ íƒ
- Instances ì—ì„œ `Create Instance` ì„ íƒ
  - Free tier ë¡œ 2ê°œë¥¼ ì œê³µí•˜ê³  ìˆìœ¼ë¯€ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œë¥¼ ë§ˆìŠ¤í„°ì™€ ì›Œì»¤ í•œê°œì”© ìƒì„±

### ì»´í“¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸° ì„¤ì •

![Configure instance](https://raw.githubusercontent.com/urunimi/urunimi.github.io/master/_posts/2021-04-17-oci-k8s/oci-2.png)

- Image ë¡œ Ubuntu ë¥¼ ì„ íƒí•˜ê³  OS ë²„ì „ì„ 18.04ë¡œ ì„ íƒ
- `Create` ì„ íƒí•´ì„œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œì‘

![List instances](https://raw.githubusercontent.com/urunimi/urunimi.github.io/master/_posts/2021-04-17-oci-k8s/oci-3.png)

## ì»´í“¨í„° ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”

### Timezone ì„¤ì •

ì•„ë˜ì˜ ëª…ë ¹ì–´ë¡œ íƒ€ì„ì¡´ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•œ ë‹¤ìŒ ì„œìš¸ íƒ€ì„ì¡´ì„ ì„¤ì •í•˜ê³  ì¬ë¶€íŒ… í•©ë‹ˆë‹¤.

```sh
$ sudo apt install tzdata
$ sudo ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime

$ sudo reboot
```

ë‹¤ì‹œ ì ‘ì†í–ˆì„ ë•Œ ì‹œê°„ì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

### iptablesì— ê·œì¹™ ì¶”ê°€

k3sëŠ” ë‚´ë¶€ì ìœ¼ë¡œ 10.43.0.x ì™€ ê°™ì€ IPë¥¼ ì‚¬ìš©í•´ì„œ ì»¨í…Œì´ë„ˆê°„ í†µì‹ ì„ í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ `10.0.0.0/8` ê·œì¹™ìœ¼ë¡œ `ACCEPT` ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

```sh
sudo iptables -I INPUT 9 -s 10.0.0.0/8 -j ACCEPT
sudo iptables -I INPUT 10 -d 10.0.0.0/8 -j ACCEPT

sudo iptables -I FORWARD 9 -s 10.0.0.0/8 -j ACCEPT
sudo iptables -I FORWARD 10 -d 10.0.0.0/8 -j ACCEPT

sudo netfilter-persistent save
```

### VCN ì— Ingress ê·œì¹™ ì¶”ê°€

k3s ë…¸ë“œê°„ì˜ í†µì‹ ì´ë‚˜ K8s í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ì†í•˜ê¸° ìœ„í•´ì„œëŠ” `6443` í¬íŠ¸ë¥¼ ì—´ì–´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. Ingress ê·œì¹™ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

- Networking ì§„ì…
- Virtual Cloud Networks -> cluster ì„ íƒ -> Ingress Rules
- Add Ingress Rules 

ì•„ë˜ì™€ ê°™ì´ ì„¤ì •ë˜ë„ë¡ ê·œì¹™ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

![Ingress Rules](https://raw.githubusercontent.com/urunimi/urunimi.github.io/master/_posts/2021-04-17-oci-k8s/oci-4.png)

> ğŸ’¡ ì—¬ê¸°ì„œëŠ” Source ë¥¼ ëª¨ë“  IP ì— ì—´ì–´ì¤¬ëŠ”ë° ì‹¤ì œë¡œ ì´ë ‡ê²Œ ìš´ì˜í•˜ë©´ ì•ˆë©ë‹ˆë‹¤.
> ì ‘ì†ì„ í—ˆìš©í•  IP ëŒ€ì—­ì„ ì œí•œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. 

ì´ì œ k3s ë¥¼ ì„¤ì¹˜í•˜ê¸° ìœ„í•œ ëª¨ë“  ì¤€ë¹„ê°€ ë§ˆë¬´ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.
k3s ì„¤ì¹˜ ë°©ë²•ì€ í¬ê²Œ ë‘ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤.

- ì§ì ‘ ì„¤ì¹˜
- `k3sup` ì„ ì´ìš©í•´ì„œ ì„¤ì¹˜

`k3sup` ì„ ì´ìš©í•´ì„œ ì„¤ì¹˜í•˜ëŠ” ê²ƒì´ ë” ì‰½ìŠµë‹ˆë‹¤.

## k3s ì§ì ‘ ì„¤ì¹˜

### ë§ˆìŠ¤í„° ë…¸ë“œì— k3s ì„¤ì¹˜

ì•„ë˜ì˜ ëª…ë ¹ìœ¼ë¡œ `k3s` ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤. ì•„ë˜ ì˜µì…˜ì€ ë§ˆìŠ¤í„° ë…¸ë“œì— ì„¤ì¹˜í•˜ëŠ” ì˜µì…˜ìœ¼ë¡œ ì›Œì»¤ ë…¸ë“œì—ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´ëŠ” ë‹¤ë¦…ë‹ˆë‹¤.

```sh
$ curl -sfL https://get.k3s.io | sh -
```

ì´ì œ ì›Œì»¤ ë…¸ë“œì— í•„ìš”í•œ ë‘ê°€ì§€ ì •ë³´ë¥¼ íšë“í•©ë‹ˆë‹¤.

- ë‚´ë¶€(Internal) IP
- k3s í† í°

ë¨¼ì € IPë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

```sh
$ ip addr | egrep "10.0.0."
# inet 10.0.0.246/24 brd 10.0.0.255 scope global ens3
```

ìœ„ì™€ ê°™ì€ ê²½ìš° `10.0.0.246` ê°€ IP ì…ë‹ˆë‹¤. 
ì´ì œ í† í°ì„ í™•ì¸í•©ë‹ˆë‹¤.

```sh
$ sudo cat /var/lib/rancher/k3s/server/node-token
# token::server::token
```

ì´ì œ ì›Œì»¤ ë…¸ë“œë¡œ ê°‘ë‹ˆë‹¤.

### ì›Œì»¤ ë…¸ë“œì— k3s ì„¤ì¹˜

```sh
$ curl -sfL https://get.k3s.io | K3S_URL=https://10.0.0.246:6443
# K3S_TOKEN=token::server::token sh -
```

## k3s ì„¤ì¹˜ í™•ì¸

### ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì„¤ì¹˜ í™•ì¸

ì•„ë˜ì™€ ê°™ì´ Pod ë“¤ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```sh
$ sudo kubectl get po --all-namespaces
# NAME                                      READY   STATUS      RESTARTS   AGE
# helm-install-traefik-qwxpc                0/1     Completed   0          12m
# metrics-server-86cbb8457f-86kcz           1/1     Running     0          44m
# svclb-traefik-j7lcw                       2/2     Running     0          11m
# traefik-6f9cbd9bd4-rnmkz                  1/1     Running     0          11m
# coredns-854c77959c-cn2r7                  1/1     Running     0          44m
# local-path-provisioner-5ff76fc89d-6f4sc   1/1     Running     0          44m
```

## k3s ì„¤ì¹˜ ì‚­ì œ

### ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ k3s ì‚­ì œ

```sh
$ /usr/local/bin/k3s-uninstall.sh
```

### ì›Œì»¤ ë…¸ë“œì—ì„œ k3s ì‚­ì œ

```sh
$ /usr/local/bin/k3s-agent-uninstall.sh
```

## k3sup ì´ìš©

[k3sup](https://github.com/alexellis/k3sup) ì„ ì´ìš©í•˜ë©´ ì¢€ë” ì‰½ê²Œ k3s ë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ìœ„ì˜ ê³¼ì •ì—ì„œ í† í°ì„ íšë“ í•˜ê±°ë‚˜ IP ë¥¼ ì°¾ëŠ” ë“±ì˜ ê³¼ì •ì„ ìƒëµí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

### k3sup ë‹¤ìš´ë¡œë“œ

ìœ„ì˜ ì‚¬ì´íŠ¸ì— ì ‘ì†í•˜ì‹œë©´ ê° í™˜ê²½ì— ë§ê²Œ ì„¤ì¹˜í•˜ëŠ” ë°©ë²•ì´ ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì €ëŠ” Mac OS (ARM64) ì‹œìŠ¤í…œì— ì„¤ì¹˜í–ˆìŠµë‹ˆë‹¤.

```sh
$ curl -sLS https://get.k3sup.dev | sh
$ sudo cp k3sup-darwin /usr/local/bin/k3sup
```

### ë§ˆìŠ¤í„° ë…¸ë“œì— k3s ì„¤ì¹˜

`${MASTER_IP}` ë§Œìœ¼ë¡œ ì„¤ì¹˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```sh
$ k3sup install \
  --ip ${MASTER_IP} \
  --user ubuntu \
  --k3s-extra-args "--cluster-init"
```

ì•„ë˜ì˜ ì»¤ë§¨ë“œë¡œ k3s ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ `$HOME/.kube/config` ì— ë‹¤ìš´ë¡œë“œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sh
$ k3sup install \
  --ip ${MASTER_IP} \
  --user ubuntu \
  --merge \
  --local-path $HOME/.kube/config \
  --context oci-k3s \
  --k3s-extra-args "--cluster-init"
```

ìœ„ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ í˜„ì¬ ê²½ë¡œì— `kubeconfig` íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ íŒŒì¼ì•ˆì— ì ‘ì† ì •ë³´ê°€ ë‹´ê²¨ìˆìŠµë‹ˆë‹¤.

### ì›Œì»¤ ë…¸ë“œì— k3s ì„¤ì¹˜

`${MASTER_IP}` ì™€ `${WORKER_IP}` ë¥¼ ë„˜ê²¨ì£¼ë©´ ì§ì ‘ì„¤ì¹˜í•  ë•Œ ë²ˆê±°ë¡œìš´ ê³¼ì •ë“¤ì„ `k3sup` ì´ ëŒ€ì‹ í•´ì¤ë‹ˆë‹¤.

```sh
k3sup join --ip ${WORKER_IP} --user ubuntu --server-ip ${MASTER_IP} --server-user ubuntu
```

### ì„¤ì¹˜ í™•ì¸

ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ê°€ ë§ˆë¬´ë¦¬ ë˜ì—ˆëŠ”ì§€ ì•„ë˜ì˜ ëª…ë ¹ì–´ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sh
$ export KUBECONFIG=./kubeconfig

$ kubectl config set-context default
# Context "default" modified.

$ kubectl get node -o wide
# NAME             STATUS   ROLES         ...
# cluster-master   Ready    etcd,master   ...
# cluster-worker   Ready    <none>        ...
```
