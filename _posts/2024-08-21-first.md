---
layout: single
title: "[ NestJS ] ì¸í„°ì…‰í„°ì™€ ê°€ë“œì˜ ì°¨ì´ì "
typora-root-url: ../
categories: [ğŸ“Œ NESTJS]
tag: [Guard, Interceptor]
author_profile: false # ì—°ë½ì²˜ ì •ë³´ ìˆ¨ê¸°ê¸°
sidebar: # ì‚¬ì´ë“œë°” ë„¤ì´ê²Œì´ì…˜ ìˆ˜ì •
  # nav: "docs" # /_data/navigation.ymlì˜ docsë¥¼ ì˜ë¯¸
  nav: "counts"
search: true

---



## NestJS Life Cycle

![nestjs_lifecycle](/images/2024-08-21-first/nestjs_lifecycle.webp)

NestJSë¡œ ê°œë°œì„ í•˜ë©´ì„œ ìš”ì²­ê³¼ ì‘ë‹µì„ íš¨ê³¼ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ìœ„ ìƒì• ì£¼ê¸°ì˜ ì¤‘ìš”ì„±ì„ ëŠë¼ê²Œ ë˜ì—ˆë‹¤.
ê·¸ ì¤‘ ê¸°ëŠ¥ê³¼ ì—­í• ì— ëŒ€í•´ í˜¼ë€ì´ ìˆì—ˆë˜ Guardì™€ Interceptorì— ëŒ€í•´ì„œ ì •í™•í•˜ê²Œ ì´í•´í•˜ê³ ì í•œë‹¤.



## Guard

### 1. ê°œë…

- ê°€ë“œë€ NestJsì—ì„œ ìš”ì²­ì´ ì²˜ë¦¬ë˜ê¸° ì „, ë‹¤ì‹œ ë§í•´ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì§„ì…ë˜ê¸° ì „ì— ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì—­í• ì„ í•´ì£¼ëŠ” ì»´í¬ë„ŒíŠ¸ë‹¤. ìš©ì–´ ê·¸ëŒ€ë¡œ ì…êµ¬ì»·ì„ í•´ì£¼ëŠ” ë°©íŒ¨ë§‰ì´ ì—­í• ì„ í•´ì¤€ë‹¤ê³  ìƒê°í•˜ë©´ ì´í•´ê°€ ì‰½ë‹¤.
- í•„ìš”í•œ ê¶Œí•œì´ë‚˜ ìê²©ì¦ëª…ì´ ìˆëŠ”ì§€ë¥¼ í™•ì¸í•´ì£¼ëŠ” ì—­í• ë¡œ ë³´í†µ `ì¸ì¦`ì´ë‚˜ `ì¸ê°€`ë¥¼ ìœ„í•´ ì‚¬ìš©ëœë‹¤.
- ì‹¤í–‰ì‹œì ì€ ë¼ìš°í„° í•¸ë“¤ëŸ¬ì— ë„ë‹¬í•˜ê¸° ì „ì— ì‹¤í–‰ëœë‹¤.

### 2. êµ¬í˜„

```typescript
@Injectable()
export class AuthGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    return validateRequest(request);
  }
}
```

- ê°€ë“œì—ì„œ ê²€ì¦ì„ ëë‚´ë©´ `true`ë¥¼ ë¦¬í„´í•´ì•¼ ìš”ì²­ì´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰ë  ìˆ˜ ìˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ `false`ë¥¼ ë°˜í™˜í•˜ë©´ ëœë‹¤. 
  í˜„ì‹¤ ì„¸ê³„ì—ì„œ í´ëŸ½ì—ì„œ ì…êµ¬ ì»·ì„ í•˜ëŠ” ë©ì¹˜ í° ê°€ë“œê°€ yes or noë¥¼ í•˜ëŠ” ê²ƒ ê°™ì•„ì„œ ì¬ë°Œë‹¤.
- ê°€ë“œëŠ” `CanActive` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³ , `@UseGuards()`ë¼ëŠ” ë°ì½”ë ˆì´í„°ë¥¼ í˜¸ì¶œí•˜ì—¬ ê°€ë“œë¥¼ ì¸ìë¡œ ë„£ì–´ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```typescript
@UseGuards(Guard1, Guard2)
@Controller('cats')
export class CatsController {
  constructor(private catsService: CatsService) {}

  @UseGuards(Guard3)
  @Get()
  getCats(): Cats[] {
    return this.catsService.getCats();
  }
}
```

- ê°€ë“œ ì‹¤í–‰ì€ `Global Guard` -> `Controller Guard` -> `Router Guard` ìˆœìœ¼ë¡œ ì§„í–‰ëœë‹¤.
- ìœ„ ì½”ë“œì—ì„œ ê°€ë“œ ì‹¤í–‰ìˆœì„œëŠ” Guard1 -> Guard2 -> Guard3ì´ë‹¤.

### 3. ì‹¤ì‚¬ìš© ì˜ˆì œ

```typescript
@Injectable()
export class ApiKeyGuard extends BaseGuard {
  constructor(private readonly commonService: CommonService) {
    super();
  }

  async handleRequest(context: ExecutionContext) {
    const request = context.switchToHttp().getRequest();
    .
    .
    .
    if (signature !== hashedMessage) {
      throw new UnauthorizedException('INVALID API KEY');
    }

    return true;
  }
}
```





## Interceptor

### 1. ê°œë…

- ì¸í„°ì…‰í„°ë€ ë§ ê·¸ëŒ€ë¡œ ìš”ì²­ì„ ê°€ë¡œì±„ì„œ íŠ¹ì •í•œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì´ë‹¤. ì—¬ê¸°ì„œ íŠ¹ì •í•œ ê¸°ëŠ¥ì´ë€,
  - ë©”ì„œë“œ ì‹¤í–‰ ì „/í›„ì— ì¶”ê°€ ë¡œì§ì„ ë°”ì¸ë”©
  - í•¨ìˆ˜ì—ì„œ ë°˜í™˜ëœ ê²°ê³¼ë¥¼ ë³€í™˜
  - í•¨ìˆ˜ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ë³€í™˜
  - ê¸°ë³¸ ê¸°ëŠ¥ ë™ì‘ì„ í™•ì¥
  - íŠ¹ì • ì¡°ê±´(ì˜ˆ: ìºì‹± ëª©ì )ì— ë”°ë¼ í•¨ìˆ˜ë¥¼ ì™„ì „íˆ ì¬ì •ì˜
- ì¸í„°ì…‰í„°ëŠ” ìš”ì²­/ì‘ë‹µì„ ë³€í™˜í•˜ê±°ë‚˜ ìš”ì²­ì˜ íë¦„ì„ ìˆ˜ì •í•˜ëŠ”ë° ì‚¬ìš©ëœë‹¤. ì¦‰ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ê³¼ ë‚˜ê°€ëŠ” ì‘ë‹µì„ ëª¨ë‘ ê°€ê³µí•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤.
- ì¸í„°ì…‰í„°ëŠ” ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ê°€ í˜¸ì¶œë˜ê¸° ì „ê³¼ í›„ì— ì´ 2ë²ˆ ì‹¤í–‰ëœë‹¤.

- ì¸í„°ì…‰í„°ëŠ” AOP(Aspect-oriented programming, ê´€ì  ì§€í–¥ í”„ë¡œê·¸ë˜ë°)ì—ì„œ ì˜ê°ì„ ë°›ì€ ê¸°ìˆ ë¡œ 

### 2. êµ¬í˜„

```typescript
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';

@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    console.log('Before...');

    const now = Date.now();
    return next
      .handle()
      .pipe(
        tap(() => console.log(`After... ${Date.now() - now}ms`)),
      );
  }
}
```

- ì¸í„°ì…‰í„°ëŠ” `NestInterceptor` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³ , `@UseInterceptors()` ë¼ëŠ” ë°ì½”ë ˆì´í„°ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ê°„ë‹¨íˆ ê³µí™ˆì—ì„œì˜ ì˜ˆì‹œë¥¼ ê°€ì ¸ì™”ë‹¤.



```typescript
@UseInterceptors(LoggingInterceptor)
export class CatsController {}
```

- íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ì— ì ìš©í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```typescript
const app = await NestFactory.create(AppModule);
app.useGlobalInterceptors(new LoggingInterceptor());
```

- ìœ„ì™€ ê°™ì´ ì„¤ì •í•˜ì—¬ ê¸€ë¡œë²Œ ì¸í„°ì…‰í„°ë¡œ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.



### 3. ì‹¤ì‚¬ìš© ì˜ˆì œ

```typescript
@Injectable()
export class ResponseInterceptor<T> implements NestInterceptor<T, Response<T>> {
  intercept(context: ExecutionContext, next: CallHandler<T>): Observable<Response<T>> {
    return next.handle().pipe(
      map((data) => ({
        timestamp: new Date().toISOString(),
        statusCode: context.switchToHttp().getResponse().statusCode,
        result: data,
      })),
    );
  }
}
```

- ë‹¤ì–‘í•œ ì‚¬ìš© ì˜ˆì œê°€ ìˆì„ ìˆ˜ ìˆì§€ë§Œ, ìœ„ ì¼€ì´ìŠ¤ëŠ” ë¦¬í„´ê°’ì— í†µì¼ì„±ì„ ì£¼ê¸° ìœ„í•´ ìœ„ì™€ ê°™ì´ ê°€ê³µí•˜ì—¬ ì‚¬ìš©í•œ ì¸í„°ì…‰í„°ì´ë‹¤. 



## Guardì™€ Interceptorì˜ ì°¨ì´ì 

1. ì¤‘ì 
   - ê°€ë“œ : ì ‘ê·¼ê³¼ ì¸ê°€ì— ì´ˆì 
   - ì¸í„°ì…‰í„° : ìš”ì²­ê³¼ ì‘ë‹µ í”„ë¡œì„¸ìŠ¤ì— ë™ì‘ì„ ë³€í™˜í•˜ê±°ë‚˜ ì¶”ê°€í•˜ëŠ”ë° ì¤‘ì 
2. ì‹¤í–‰ ì‹œì 
   - ê°€ë“œ : ìš”ì²­ì´ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ì— ë„ë‹¬í•˜ê¸° ì „ì— ì‹¤í–‰
   - ì¸í„°ì…‰í„° : ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ ì „ê³¼ í›„ ì´ 2ë²ˆ ì‹¤í–‰
3. ì‚¬ìš© ëª©ì 
   - ê°€ë“œ : ìš”ì²­ì— ëŒ€í•œ ê¶Œí•œì„ í™•ì¸í•´ì•¼ í•  í•„ìš”ê°€ ìˆëŠ” ê²½ìš°
   - ì¸í„°ì…‰í„° : ìš”ì²­ê³¼ ì‘ë‹µì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì¶”ê°€ ì²˜ë¦¬ë¥¼ í•´ì•¼ í•  ê²½ìš°



ì°¸ê³ 

https://docs.nestjs.com/faq/request-lifecycle#guards

https://docs.nestjs.com/interceptors

https://javascript.plainenglish.io/nestjs-roadmap-for-beginners-4fee5be251b

https://jake-seo-dev.tistory.com/726

https://changhyeon.net/nestjs--life-cycle
