---
layout: single
title:  "YOLOV3 - Cardetection ì‹¤ìŠµ"
categories : yolo
tag : [ultratics, object-detection, Yolo, ë”¥ëŸ¬ë‹]
toc: true
toc_sticky: true

---

![header](https://capsule-render.vercel.app/api?type=waving&color=a2dcec&height=300&section=header&text=YOLOV3 - Cardetection ì‹¤ìŠµ&fontSize=40&animation=fadeIn&fontAlignY=38&fontColor=FFFFFF)

- [Kaggle ë°ì´í„°ì…‹](https://www.kaggle.com/datasets/sshikamaru/car-object-detection)

<table align="left">
  <td>
    <a target="_blank" href="https://colab.research.google.com/github/choijhyeok/Collection-of-presentation-materials/blob/main/YOLOv3_example.ipynb"><img src="https://www.tensorflow.org/images/colab_logo_32px.png" />êµ¬ê¸€ ì½”ë©ì—ì„œ ì‹¤í–‰í•˜ê¸°</a>
  </td>
</table>




&nbsp;

## Car detection

&nbsp;

### ë°ì´í„° í™•ì¸

![image-20221124113007369](/images/2022-11-24-Yolov3_2/image-20221124113007369.png)

- ì´ë¯¸ì§€ì— ëŒ€í•œ xmin, ymin, xmax, ymax ë¡œ ì´ë£¨ì–´ì§„ ë°ì´í„°ì…‹

![image-20221124113101251](/images/2022-11-24-Yolov3_2/image-20221124113101251.png)

- cv2 rectangle ì„ í†µí•´ì„œ ì‹œê°í™” í–ˆì„ë•Œ labelingì´ ì˜ëœ ëª¨ìŠµì„ í™•ì¸í• ìˆ˜ ìˆìŒ

&nbsp;

### format ë³€í™˜

- í˜„ì¬ ë°ì´í„°ëŠ” xmin, ymin, xmax, ymaxë¡œ ì´ë£¨ì–´ì§„ ë°ì´í„°
- ì‚¬ìš©í•  ëª¨ë¸ì¸ Yolov3 formatì€ x_center, y_center, w, h ì™€ ê°™ì€ ì •ë³´ê°€ í•„ìš”í•¨ìœ¼ë¡œ ë°ì´í„° ê°€ê³µ ìˆ˜í–‰

```python
img_h, img_w, num_channels = h, w, c # h, w, c ëŠ” ìœ„ì—ì„œ ì–»ì€ ì´ë¯¸ì§€ í¬ê¸°


# x_center ìƒì„±
data_df['x_center'] = (data_df['xmin'] + data_df['xmax'])/2
data_df['x_center'] = data_df['x_center']/img_w

# y_center ìƒì„±
data_df['y_center'] = (data_df['ymin'] + data_df['ymax'])/2
data_df['y_center'] = data_df['y_center']/img_h

# width ìƒì„±
data_df['w'] = data_df['xmax'] - data_df['xmin']
data_df['w'] = data_df['w']/img_w

# height ìƒì„±
data_df['h'] = data_df['ymax'] - data_df['ymin']
data_df['h'] = data_df['h']/img_h

# class ìƒì„±
data_df['classes'] = 0

data_df.head()
```

- ê¸°ë³¸ì ìœ¼ë¡œ ê²€ì¶œí•  classê°€ ëª¨ë‘ 'car' í•˜ë‚˜ì˜ ë‹¨ì¼ í´ë˜ìŠ¤ ì„ìœ¼ë¡œ 0ìœ¼ë¡œ í†µì¼
- ì´ë¯¸ì§€ì˜ ë†’ì´, ë„ˆë¹„, ì±„ë„ì— ëŒ€í•œ ì •ë³´ëŠ” image.size ë¥¼ í†µí•´ì„œ ì–»ì„ìˆ˜ ìˆê³  í•´ë‹¹ ë°ì´í„°ëŠ” ëª¨ë‘ ì´ë¯¸ì§€ w,h ê°€ ë™ì¼í•¨

&nbsp;

### Yolov3 í´ë” í˜•ì‹ ë° ë°ì´í„° ë¶„í• 

- ì‚¬ìš©í•  ëª¨ë¸ì¸ Yolov3ëŠ” format ì´ì™¸ì—ë„ íŒŒì¼ì— ëŒ€í•œ ì¡°ê±´ì´ ì¡´ì¬ 
- ì•Œë§ëŠ” í˜•ì‹ìœ¼ë¡œ íŒŒì¼ì„ ì‘ì„±í•´ì¤˜ì•¼ ë¬¸ì œì—†ì´ ì‘ë™

```markdown
# yolov3 íŒŒì¼ í˜•ì‹

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
 ğŸ“Â yolov3_car_data 
   â”œâ”€â”€â”€â”€ğŸ“ƒ data.yaml : ë°ì´í„°ì˜ ê²½ë¡œ ë° class ë‚´ìš©ì´ ë‹´ê¸´ yaml íŒŒì¼
   â”œâ”€â”€ğŸ“ images : tarin,val,test ì´ë¯¸ì§€ê°€ ë“¤ì–´ìˆëŠ” í´ë”
   â”‚    â”œâ”€â”€ğŸ“ train     
   â”‚    â”œâ”€â”€ğŸ“ val
   â”‚    â””â”€â”€ğŸ“ test
   â”‚    
   â”œâ”€â”€ğŸ“ labels : tarin,val labelì´ ë“¤ì–´ìˆëŠ” í´ë”
   â”‚    â”œâ”€â”€ğŸ“ train      
   â”‚    â””â”€â”€ğŸ“ val 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

&nbsp;

- í•´ë‹¹ í˜•ì‹ì˜ í´ë”ë¥¼ ì†ìœ¼ë¡œ ì‘ì„±í• ìˆ˜ ìˆì§€ë§Œ ê·¸ë ‡ê²Œ ë˜ë©´ ë²ˆê±°ë¡­ê¸° ë•Œë¬¸ì— os.makedirsë¥¼ í†µí•´ì„œ ìƒì„±

```python
# ìœ„ì˜ í´ë” í˜•ì‹ì„ ë§Œë“œëŠ” í•¨ìˆ˜
def make_dir():
    if not os.path.exists('./yolov3_car_data'):
        os.makedirs('./yolov3_car_data')

    if not os.path.exists('./yolov3_car_data/images/'):
        os.makedirs('./yolov3_car_data/images/')

    if not os.path.exists('./yolov3_car_data/labels/'):
        os.makedirs('./yolov3_car_data/labels/')

    for i in ['train','val']:
        if not os.path.exists(f'./yolov3_car_data/images/{i}/'):
            os.makedirs(f'./yolov3_car_data/images/{i}/')
        if not os.path.exists(f'./yolov3_car_data/labels/{i}/'):
            os.makedirs(f'./yolov3_car_data/labels/{i}/')

# ê²½ë¡œ ìƒì„±
make_dir()
```

&nbsp;

### ì´ë¯¸ì§€ ë° ë¼ë²¨ íŒŒì¼ ë¶„ë¦¬

- í˜„ì¬ dataframe ì•ˆì— ì´ë¯¸ì§€ë³„ í•´ë‹¹ ì´ë¯¸ì§€ì— ëŒ€í•œ x_center, y_center, width, height ì¡´ì¬
- ì´ë¥¼ .txt íŒŒì¼ ì•ˆì— 'classes','x_center','y_center','w','h' ìˆœìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•¨ (ì´ë¯¸ì§€ ë³„ë¡œ)

```python
# data_df image ì¤‘ train : valid ë¶„ë¦¬
split_data = list(set(list(data_df['image'])))
train_valid_split = random.sample(split_data, k= 210) # 210ê°œëŠ” train : 90ê°œëŠ” val

# ì‹¤ì œ yolo formatì— ì‚¬ìš©ë˜ëŠ” class, x_center, y_center, width, height ë§Œ ë‚¨ê¸°ê¸°
for name,sep in tqdm(data_df.groupby('image')):
    if name in train_valid_split:
        folder = 'train'
    else:
        folder = 'val'

    with open(f'./yolov3_car_data/labels/{folder}/{name.split(".")[0]}.txt', 'w+') as f:
        row = sep[['classes','x_center','y_center','w','h']].astype(float).values
        row = row.astype(str)
        for j in range(len(row)):
            text = ' '.join(row[j])
            f.write(text)
            f.write("\n")

    sh.copy(f"./car_detection/train/{name}",f'./yolov3_car_data/images/{folder}/{name}')
```

- groupbyë¡œ imageë¥¼ í•˜ëŠ” ì´ìœ ëŠ” í•œ ì´ë¯¸ì§€ì•ˆì— ê°ì²´ê°€ 2ê°œ ì´ìƒì¼ ê²½ìš° annotions ëª¨ë‘ë¥¼ labelì— ì‘ì„±í•˜ê¸° ìœ„í•¨

&nbsp;

### yaml íŒŒì¼ ìƒì„±

- ëª¨ë“  ê³¼ì •ì´ ëë‚˜ê³  ìµœì¢…ì ìœ¼ë¡œ modelì—ê²Œ train,val,test ë°ì´í„° ìœ„ì¹˜ì™€ class ì´ë¦„ ë° ê°œìˆ˜ë¥¼ ì•Œë ¤ì£¼ëŠ” yaml íŒŒì¼ ì‘ì„±
- pythonì˜ open() write()ë¥¼ í†µí•´ì„œë„ ì‘ì„±í• ìˆ˜ ìˆì§€ë§Œ ê°€ì¥ í¸í•œ ë°©ë²•ìœ¼ë¡œ ì‘ì„±

```python
%%writefile ./yolov3_car_data/data.yaml
train : ../yolov3_car_data/images/train
val : ../yolov3_car_data/images/val
test: ../yolov3_car_data/images/test

nc : 1
names: [car]
```

&nbsp;

### ëª¨ë¸ í›ˆë ¨

- ê¸°ë³¸ì ìœ¼ë¡œ í•™ìŠµì´ ì˜ëœ ìƒíƒœë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ì„œ ê°œì¸ì»´ìœ¼ë¡œ 1000 epoch ìˆ˜í–‰í•œ ê°€ì¤‘ì¹˜ë¡œ ì¬í•™ìŠµ
- batch : í•œë²ˆì— í›ˆë ¨ì‹œí‚¬ ì´ë¯¸ì§€ ìˆ˜
- epochs : í›ˆë ¨ íšŸìˆ˜
- weight : ì‚¬ìš©í•  ëª¨ë¸ ê°€ì¤‘ì¹˜ (ì—¬ê¸°ì„œëŠ” ì´ë¯¸ 1000ë²ˆ ëŒë¦° ê°€ì¤‘ì¹˜ ì‚¬ìš©), ì•ˆì ìœ¼ë©´ ì•Œì•„ì„œ yolov3.pth ë‹¤ìš´
- exist-ok : ê²°ê³¼ë¬¼ í´ë” í•˜ë‚˜ë¡œ í†µì¼
- device : ì‚¬ìš©í•  gpu ë„˜ë²„

```python
os.chdir('./yolov3') # yolov3 í´ë”ë¡œ ì´ë™

!python train.py  --batch 16 --epochs 5 --data ../yolov3_car_data/data.yaml --exist-ok --weights ../car_detection/best.pt --cache --device 0
```

- ëª¨ë¸ ì¶”ë¡ 
  - ./runs/train/exp/weights/best.pt ì— ìœ„ì—ì„œ 5 epoch ëŒë¦° ëª¨ë¸ì´ ì €ì¥ë¨

```python
!python ./detect.py --weights ./runs/train/exp/weights/best.pt --conf 0.25 --line-thickness 1 --exist-ok --device 0 --source  ../yolov3_car_data/images/test
```

&nbsp;

### ëª¨ë¸ ê²°ê³¼ ì‹œê°í™”

![image-20221124114613990](/images/2022-11-24-Yolov3_2/image-20221124114613990.png)

- í™•ì‹¤í•˜ê²Œ ultralytics yolov3ëŠ” ê¸°ì¡´ yolov3 ë³´ë‹¤ ì„±ëŠ¥ë©´ì—ì„œ ì¢‹ì€ ê²½í–¥ì„ ë³´ì„
- formatì˜ í˜•íƒœê°€ ultralytics yolov5ì™€ ê°™ì•„ì„œ ì‚¬ì‹¤ìƒ yolov3 ë‚˜ yolov5 ì•„ë¬´ê±°ë‚˜ ì‚¬ìš©í•´ë„ ë¬¸ì œ ì—†ì§€ë§Œ yolov5ëŠ” ìì²´ì ìœ¼ë¡œ ëª¨ìì´í¬ë¥¼ ë„£ì–´ì„œ ë°ì´í„°ë¥¼ í•™ìŠµì‹œí‚¤ëŠ” ë¶€ë¶„ ë•Œë¬¸ì— ì ì€ ë°ì´í„°ì…‹ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ê±´ ë¶€ì ì ˆ í•˜ë‹¤ê³  íŒë‹¨

&nbsp;

### ëìœ¼ë¡œ

- Kaggle ë°ì´í„° ì…‹ì„ í†µí•´ì„œ yolov3 ë¥¼ í•´ë³´ëŠ” ì‹¤ìŠµì„ ì˜¬ë ¤ë³´ê³  ì‹¶ì—ˆëŠ”ë° ë§ˆì¹¨ ì¢‹ì€ ê¸°íšŒê°€ ìˆì–´ì„œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.
- ëª¨ë“  ê³¼ì •ì€ ìœ„ì— colabì—ì„œ ìˆ˜í–‰í•´ë³´ì‹¤ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.