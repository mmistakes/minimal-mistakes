---
layout: single
title:  "YOLOV3 - Ship detection ì‹¤ìŠµ"
categories : yolo
tag : [ultratics, object-detection, Yolo, ë”¥ëŸ¬ë‹]
toc: true
toc_sticky: true
---

![header](https://capsule-render.vercel.app/api?type=waving&color=a2dcec&height=300&section=header&text=YOLOV3 - Ship detection ì‹¤ìŠµ&fontSize=40&animation=fadeIn&fontAlignY=38&fontColor=FFFFFF)

- [Kaggle ë°ì´í„°ì…‹](https://www.kaggle.com/c/airbus-ship-detection)

<table align="left">
  <td>
    <a target="_blank" href="https://colab.research.google.com/github/choijhyeok/Collection-of-presentation-materials/blob/main/YOLOv3_example2.ipynb#scrollTo=EO-ZxAivvB3F"><img src="https://www.tensorflow.org/images/colab_logo_32px.png" />êµ¬ê¸€ ì½”ë©ì—ì„œ ì‹¤í–‰í•˜ê¸°</a>
  </td>
</table>



&nbsp;

## YOLO v3 ship_detection ì‹¤ìŠµ

- coco jsonì— bboxë¥¼ ì½ì–´ì„œ detection

&nbsp;

### YOLO v3 ë°ì´í„° ì¤€ë¹„

- Yolo v3 ì¤€ë¹„

```python
!git clone https://github.com/ultralytics/yolov3
%cd yolov3
!pip install -r requirements.txt
```

&nbsp;

- ë°ì´í„° ì¤€ë¹„

```python
# ìœ„ì¹˜ë¥¼ /contentë¡œ ì´ë™
%cd ..

# ship Object Detection ë°ì´í„°ì…‹ ë‹¤ìš´
!gdown https://drive.google.com/uc?id=1LwLwl-T4ShmcDLIDbnAch4OZMqfmk_67

# ì••ì¶• í’€ê¸°
!unzip -qq "/content/ship_rle_coco.zip"
```

- train : test ë°ì´í„° í™•ì¸

```python
train_dir = glob('./ship_rle_coco/train/*.jpg')
test_dir = glob('./ship_rle_coco/test/*.jpg')

print(f'train ì´ë¯¸ì§€ ìˆ˜ : {len(train_dir)}, test ì´ë¯¸ì§€ ìˆ˜ : {len(test_dir)}')
```

&nbsp;

### COCO ë°ì´í„°ì˜ annotations bbox ì¶”ì¶œ

````markdown
**coco ë°ì´í„°ëŠ” ì•„ë˜ì™€ ê°™ì€ íŠ¹ì„±ì´ ì¡´ì¬**
```
{
    "categories": [   # categoriesëŠ” ì‚¬ìš©í•˜ëŠ” classì˜ ë‚´ìš©ì„ ê¸°ë¡
        {
            "id": 0,
            "name": "ship",
            "supercategory": "ship"
        }
    ],
    "images": [  # images ì´ë¯¸ì§€ì˜ fileëª…, width, height ê¸°ë¡
        {
            "id": 0,
            "file_name": "thumbnail-ba5c72edb320b49a69e86b05775c49b2-scaled-1_jpeg.rf.035d587add7bc2a6c7616d72e56bfad4.jpg",
            "height": 416,
            "width": 416,
            "date_captured": "2020-05-11T04:28:59+00:00"
        },

    ],
    "annotations": [ # image_id í•´ë‹¹í•˜ëŠ” ì´ë¯¸ì§€ ë²ˆí˜¸, bboxì— bounding box ì¢Œí‘œ ê¸°ë¡
        {
            "id": 0,
            "image_id": 0,
            "category_id": 2,
            "bbox": [
                253,
                120,
                16,
                21
            ],
            "area": 336,
            "segmentation": [],
            "iscrowd": 0
        },
      ]
}
```
````

- COCO data ë¶ˆëŸ¬ì˜¤ê¸°

```python
with open('./ship_rle_coco/coco_train.json', "r") as json_file:
    json_data = json.load(json_file)
```

- coco ë°ì´í„° DataFrameì— ì €ì¥
  - yolov3 format ìˆœì„œì¸ 'classes','x_center','y_center','w','h' ë¡œ ë³€ê²½í•˜ê¸° ìœ„í•´ annotations ì˜ bbox ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

```python
image_list = {}  # ì´ë¯¸ì§€ ê³ ìœ  ë²ˆí˜¸ë¥¼ ìœ„í•´ ìƒì„±í•œ dict
for i in json_data['images']:
    image_list[i['id']] = i['file_name']


box_df = pd.DataFrame()
img_list = []
x_min_list = []
x_max_list = []
y_min_list = []
y_max_list = []

for i in json_data['annotations']:

    x_min,x_max,y_min,y_max = i['bbox']
    img_list.append(image_list[i['image_id']])
    x_min_list.append(x_min)
    x_max_list.append(x_max)
    y_min_list.append(y_min)
    y_max_list.append(y_max)


box_df['image'] = img_list
box_df['xmin'] = x_min_list
box_df['xmax'] = x_max_list
box_df['ymin'] = y_min_list
box_df['ymax'] = y_max_list
```

- Yolov3 formatìœ¼ë¡œ ë³€í™˜

```python
img_h, img_w = json_data['images'][0]['height'], json_data['images'][0]['width']

# x_center ìƒì„±
box_df['x_center'] = (box_df['xmin'] + box_df['xmax'])/2
box_df['x_center'] = box_df['x_center']/img_w

# y_center ìƒì„±
box_df['y_center'] = (box_df['ymin'] + box_df['ymax'])/2
box_df['y_center'] = box_df['y_center']/img_h

# width ìƒì„±
box_df['w'] = box_df['xmax'] - box_df['xmin']
box_df['w'] = box_df['w']/img_w

# height ìƒì„±
box_df['h'] = box_df['ymax'] - box_df['ymin']
box_df['h'] = box_df['h']/img_h

# class ìƒì„±
box_df['classes'] = 0

box_df.head()
```

- ë°ì´í„° ì‹œê°í™”

```python
cnt = 0

for i,d in box_df.groupby('image'):
  if cnt == 5:
    break
  else:
    img = imread(f'./ship_rle_coco/train/{i}')
    
    for num in range(len(d)):
      xmin,xmax,ymin,ymax = d.iloc[num][['xmin', 'xmax', 'ymin', 'ymax']]
      cv2.rectangle(img,(xmin,ymin),(xmax,ymax),(0,255,0),3)

    cv2_imshow(img)
    cnt +=1
```

![image-20221210220404761](/images/2022-12-10-Yolov3_3/image-20221210220404761.png)

&nbsp;

### yolov3 í´ë” í˜•ì‹ ë° ë°ì´í„° ë¶„í• 

 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  

 ğŸ“ yolov3_ship_data

  â”œâ”€â”€â”€â”€ğŸ“ƒ data.yaml : ë°ì´í„°ì˜ ê²½ë¡œ ë° class ë‚´ìš©ì´ ë‹´ê¸´ yaml íŒŒì¼

  â”œâ”€â”€ğŸ“ images : tarin,val,test ì´ë¯¸ì§€ê°€ ë“¤ì–´ìˆëŠ” í´ë”

  â”‚  â”œâ”€â”€ğŸ“ train   

  â”‚  â”œâ”€â”€ğŸ“ val 

  â”‚  â””â”€â”€ğŸ“ test

  â”‚  

  â”œâ”€â”€ğŸ“ labels : tarin,val labelì´ ë“¤ì–´ìˆëŠ” í´ë”

  â”‚  â”œâ”€â”€ğŸ“ train   

  â”‚  â””â”€â”€ğŸ“ val 

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   

```python
def make_dir():
    if not os.path.exists('./yolov3_ship_data'):
        os.makedirs('./yolov3_ship_data')

    if not os.path.exists('./yolov3_ship_data/images/'):
        os.makedirs('./yolov3_ship_data/images/')

    if not os.path.exists('./yolov3_ship_data/labels/'):
        os.makedirs('./yolov3_ship_data/labels/')

    for i in ['train','val']:
        if not os.path.exists(f'./yolov3_ship_data/images/{i}/'):
            os.makedirs(f'./yolov3_ship_data/images/{i}/')
        if not os.path.exists(f'./yolov3_ship_data/labels/{i}/'):
            os.makedirs(f'./yolov3_ship_data/labels/{i}/')

# ê²½ë¡œ ìƒì„±
make_dir()
```

- ë°ì´í„° ë¶„í• 

```python
# box_df ì¤‘ train : valid ë¶„ë¦¬
split_data = list(set(list(box_df['image'])))
train_valid_split = random.sample(split_data, k= 210)


for name,sep in tqdm(box_df.groupby('image')):
    if name in train_valid_split:
        folder = 'train'
    else:
        folder = 'val'

    with open(f'./yolov3_ship_data/labels/{folder}/{name.split(".")[0]}.txt', 'w+') as f:
        # ì‹¤ì œ yolov3 formatì— ì‚¬ìš©ë˜ëŠ” class, x_center, y_center, width, height ë§Œ ë‚¨ê¸°ê¸°
        row = sep[['classes','x_center','y_center','w','h']].astype(float).values
        row = row.astype(str)
        for j in range(len(row)):
            text = ' '.join(row[j])
            f.write(text)
            f.write("\n")

    sh.copy(f"./ship_rle_coco/train/{name}", f'./yolov3_ship_data/images/{folder}/{name}')
```

- test ë°ì´í„° ì˜®ê¸°ê¸°

```python
test_imgs = [i.split('/')[-1] for i in glob('./ship_rle_coco/test/*.jpg')]

for i in tqdm(test_imgs):

    if not os.path.exists('./yolov3_ship_data/images/test/'):
        os.makedirs('./yolov3_ship_data/images/test/')

    sh.copy(f"./ship_rle_coco/test/{i}", f'./yolov3_ship_data/images/test/{i}')
```

&nbsp;

### yaml íŒŒì¼ ìƒì„±

```python
%%writefile ./yolov3_ship_data/data.yaml
train : ../yolov3_ship_data/images/train
val : ../yolov3_ship_data/images/val
test: ../yolov3_ship_data/images/test

nc : 1
names: [ship]
```

&nbsp;

### ëª¨ë¸ í›ˆë ¨

```markdown
--batch : í•œë²ˆì— í›ˆë ¨ì‹œí‚¬ ì´ë¯¸ì§€ ìˆ˜ 

--epochs : í›ˆë ¨ íšŸìˆ˜

--data : .yaml ê²½ë¡œ

--weights : ì‚¬ìš©í•  ëª¨ë¸ ê°€ì¤‘ì¹˜, yolov3.py ì…ë ¥ì‹œ ìë™ìœ¼ë¡œ yolov3 ê°€ì¤‘ì¹˜ ë‹¤ìš´ (ì—°ìŠµì—ì„œëŠ” ì‚¬ì „ì— í•™ìŠµì‹œí‚¨ ëª¨ë¸ ì‚¬ìš©)
```

```python
os.chdir('./yolov3')
!python train.py --img 640 --batch 16 --epochs 5 --exist-ok --data  ../yolov3_ship_data/data.yaml --weights ../ship_rle_coco/best.pt --cache --device 0
```

- í›ˆë ¨ ê²°ê³¼ ì¶œë ¥ ë§¨ ì•„ë˜ì¤„ì— **Results saved to **ê²½ë¡œì— best.ptë¼ëŠ” ì´ë¦„ìœ¼ë¡œ í•™ìŠµ ê°€ì¤‘ì¹˜ ê°€ìš´ë° validation scoreê°€ ê°€ì¥ ì¢‹ì€ ê²°ê³¼ê°€ ì €ì¥ë¨
- ë‹¤ìŒ ì…€ì˜ --weights ì¸ìì— ìœ„ **ê²½ë¡œ/best.pt**ë¥¼ ì…ë ¥í•˜ì—¬ ì €ì¥ëœ ê°€ì¤‘ì¹˜ë¥¼ ë¶ˆëŸ¬ì™€ ì¶”ë¡  ìˆ˜í–‰

```python
!python ./detect.py --weights ./runs/train/exp/weights/best.pt --img 640 --conf 0.25 --line-thickness 1 --exist-ok --device 0 --source  ../yolov3_ship_data/images/test
```

&nbsp;

### ëª¨ë¸ ê²°ê³¼ ì‹œê°í™”

```python
data_list = glob('./runs/detect/exp/*.jpg')
random_img = random.sample(data_list, k=5)
for i in random_img:
  src = cv2.imread(i)

  cv2_imshow(src)
```

![image-20221210220814293](/images/2022-12-10-Yolov3_3/image-20221210220814293.png)