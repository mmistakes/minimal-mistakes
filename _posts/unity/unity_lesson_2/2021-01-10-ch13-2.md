---
title:  "Chapter 13-2. ë¯¸ë‹ˆ RPG : ì´ë™(NavMesh)" 

categories:
  -  Unity Lesson 2
tags:
  - [Game Engine, Unity]

toc: true
toc_sticky: true

date: 2021-01-10
last_modified_at: 2021-01-10
---

ì¸í”„ëŸ°ì— ìˆëŠ” Rookissë‹˜ì˜ **[C#ê³¼ ìœ ë‹ˆí‹°ë¡œ ë§Œë“œëŠ” MMORPG ê²Œì„ ê°œë°œ ì‹œë¦¬ì¦ˆ] Part3: ìœ ë‹ˆí‹° ì—”ì§„** ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ í•„ê¸°ì…ë‹ˆë‹¤. ğŸ˜€  
[ğŸŒœ ê°•ì˜ ë“¤ìœ¼ëŸ¬ ê°€ê¸° Click](https://www.inflearn.com/course/MMORPG-ìœ ë‹ˆí‹°)
{: .notice--warning}


# Chapter 13. ë¯¸ë‹ˆ RPG ë§Œë“¤ê¸°

## ğŸš€ ì´ˆê¸° ì„¸íŒ…

### ğŸ“œPlayerController

```c#
	void OnMouseClicked(Define.MouseEvent evt)
	{
		//...

		RaycastHit hit;
		if (Physics.Raycast(ray, out hit, 100.0f, LayerMask.GetMask("Ground")))
		{
			_destPos = hit.point;
			_state = PlayerState.Moving;
		}
	}
```

ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•˜ëŠ” ê³³ìœ¼ë¡œ í”Œë ˆì´ì–´ê°€ ì´ë™í•˜ê²Œ í–ˆì—ˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìœ„ ì½”ë“œì— ë§ì¶° `Terrain`ì˜ Layerë¥¼ "Ground"ë¡œ ë³€ê²½í•¨.

<br>

### ğŸ“œCameraController

```c#
    void LateUpdate()
    { 
        if (_mode == Define.CameraMode.QuarterView)
        {
            RaycastHit hit;
            if (Physics.Raycast(_player.transform.position, _delta, out hit, _delta.magnitude, LayerMask.GetMask("Ground")))
            {
                float dist = (hit.point - _player.transform.position).magnitude * 0.8f;
                transform.position = _player.transform.position + _delta.normalized * dist;
            }
            else
            {
				transform.position = _player.transform.position + _delta;
				transform.LookAt(_player.transform);
			}
		}
    }
```

ì´ë ‡ê²Œ ì¹´ë©”ë¼ë„ ê°€ë ¤ì§€ëŠ”ê±¸ ë°©ì§€í•  ìˆ˜ ìˆë„ë¡ ì²˜ë¦¬í–ˆì—ˆë‹¤. ê·¸ë˜ì„œ ë¹Œë”© ì˜¤ë¸Œì íŠ¸ë“¤ë„ Layerë¥¼ "Ground"ë¡œ ë³€ê²½í•¨. ì´ ì˜¤ë¸Œì íŠ¸ë“¤ì— ì¹´ë©”ë¼ê°€ ì¶©ëŒí•˜ë©´ ê°€ë ¤ì ¸ì„œ í”Œë ˆì´ì–´ë¥¼ ëª» ì°ìœ¼ë‹ˆê¹Œ ë°”ë¡œ ë‹¤ì‹œ í”Œë ˆì´ì–´ë¥¼ ì°ì„ ìˆ˜ ìˆë„ë¡.. (í•œ 0.8 ê±°ë¦¬ë¡œ ì¡°ì •í•´ì„œ ë‹¤ì‹œ ìœ„ì¹˜ ì„¸íŒ…)

<br>

## ğŸš€ ì´ë™í•˜ê¸°

> ê·¼ë° ì´ë ‡ê²Œ ë¹Œë”©ë“¤ë„ "Ground"ì´ ë˜ë‹ˆ í”Œë ˆì´ì–´ê°€ ë¹Œë”© ìœ„ë¡œ!! ì´ë™í•  ìˆ˜ë„ ìˆëŠ” ë¬¸ì œê°€ ìƒê¸´ë‹¤. 

- í•´ê²° ë°©ë²•
  1. í”Œë ˆì´ì–´ì˜ ì½œë¼ì´ë”ì™€ ì¶©ëŒì´ ì¼ì–´ë‚˜ë©´ í”¼í•˜ê²Œ í•˜ë˜ê°€
  2. í”Œë ˆì´ì–´ë¡œë¶€í„° ìœ Raycastì— ê±¸ë¦¬ëŠ” ê³³ìœ¼ë¡œëŠ” ì´ë™í•˜ì§€ ëª»í•˜ë„ë¡ ë§‰ì„ ìˆ˜ ì‡ê² ë‹¤. 
  3. NavMesh ì‚¬ìš©í•˜ì—¬ ê°ˆ ìˆ˜ ìˆëŠ” ê³³ìœ¼ë¡œë§Œ ê°€ê²Œ í•˜ê¸°.
    - ğŸ‘‰ ì„¸ ë²ˆì§¸ ë°©ë²•ì„ ì‚¬ìš©í•´ë³´ì.

ìœ„ 3 ê°€ì§€ë¥¼ ì ì ˆíˆ ì„ì–´ì„œ ê²½ìš°ì— ë”°ë¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆê² ë‹¤.

### âœˆ NavMesh

> Window - AI - Navigation

![image](https://user-images.githubusercontent.com/42318591/104124130-53ba9700-5392-11eb-9225-01a8ad4e7593.png)


`Baked`ë¡œ ê°ˆ ìˆ˜ ìˆëŠ” ê³³ì„ ë¯¸ë¦¬ íŒë³„í•´ êµ¬ì›Œë³´ì•˜ë‹¤. íŒŒë€ìƒ‰ì€ ì „ë¶€ ê°ˆ ìˆ˜ ìˆëŠ” ê³³. 

- NavMeshì˜ ê°ˆ ìˆ˜ ìˆëŠ” ê³³ íŒë‹¨ ê¸°ì¤€
  - `static`ì´ ì²´í¬ë˜ì–´ ìˆëŠ” ì˜¤ë¸Œì íŠ¸ê°€ ìœ„ì¹˜í•œ ê³³ì€ ê°ˆ ìˆ˜ ì—†ëŠ” ê³³ì´ë¼ê³  ì¸ì‹ì„ í•œë‹¤. `static`ì´ ì²´í¬ë˜ì–´ ìˆì§€ ì•Šì€ ì˜¤ë¸Œì íŠ¸ë¼ë©´ ê·¸ ì˜¤ë¸Œì íŠ¸ëŠ” ì–¸ì œë“ ì§€ ë‹¤ë¥¸ ê³³ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆë‹¤ê³  íŒë‹¨ë˜ì–´ ê·¸ ê³³ìœ¼ë¡œ ì´ë™ì´ ê°€ëŠ¥í•˜ê²Œ ëœë‹¤.
    - ê·¸ëŸ¬ë‹ˆê¹Œ í”Œë ˆì´ì–´ë„ ë°Ÿê³  ê°ˆ ìˆ˜ ìˆëŠ” ì¥ì• ë¬¼ ì •ë„ë©´ NavMesh ì—ì„œ ì´ë¥¼ ê°ˆ ìˆ˜ ìˆëŠ” ê³³ìœ¼ë¡œ ì²˜ë¦¬í•˜ê²Œë” í•´ë‹¹ ì˜¤ë¸Œì íŠ¸ì˜ `static` ì²´í¬ë¥¼ í•´ì œí•´ì£¼ë©´ ëœë‹¤.
  - ì›ê¸°ë‘¥ ì‹¤ë¦°ë”ì¸ ***NavMesh Agent***ì˜ í‚¤, ë°˜ì§€ë¦„, ë„˜ì„ ìˆ˜ ìˆëŠ” ë¬¸í„±, ê°ˆ ìˆ˜ ìˆëŠ” ê²½ì‚¬ ê°ë„ ë“±ë“±ì„ ê³ ë ¤í•˜ì—¬ ê°ˆ ìˆ˜ ìˆëŠ”ì§€ ì—†ëŠ”ì§€ë¥¼ íŒë‹¨í•œë‹¤. 
    - í”Œë ˆì´ì–´ê°€ ì§€ë¶•ì—” ëª» ì˜¬ë¼ê°€ë„ë¡ ìµœëŒ€ ê²½ì‚¬ë¥¼ ì¢€ ë‚®ì·„ë‹¤.
    - ì´ <u>NavMesh Agent ì»´í¬ë„ŒíŠ¸ê°€ ë¶™ê²Œ ë˜ëŠ” ì• ë“¤ë§Œ ìœ„ì™€ ê°™ì´ NavMesh ë¡œ ì—°ì‚°ëœ ê°ˆ ìˆ˜ ìˆëŠ” íŒŒë€ìƒ‰ ìœ„ì¹˜ë“¤ì—ë§Œ ê°ˆ ìˆ˜ ìˆê²Œ ëœë‹¤.</u>
      - ì¦‰  NavMesh Agent ì»´í¬ë„ŒíŠ¸ê°€ ìˆì–´ì•¼ì§€ë§Œ ê°ˆ ìˆ˜ ìˆëŠ” ê¸¸ ì—†ëŠ” ê¸¸ ì´ë ‡ê²Œ íŒë‹¨í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ ìƒê¸´ ë‹¤ëŠ” ê²ƒ.
      - í”Œë ˆì´ì–´ì—ê²Œ NavMesh Agent ì»´í¬ë„ŒíŠ¸ë¥¼ ë¶™ì¼ ê²ƒì´ë‹¤. Agent ì‹¤ë¦°ë”ë¥¼ í”Œë ˆì´ì–´ì—ê²Œ íˆ¬ì˜í•´ì„œ í”Œë ˆì´ì–´ì˜ í¬ê¸° ë“±ë“±ê³¼ ë§ì¶°ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤. `unityChan`ì—ê²Œ NavMesh Agent ì»´í¬ë„ŒíŠ¸ë¥¼ ë¶™ì—¬ì£¼ì.

![image](https://user-images.githubusercontent.com/42318591/104125474-473a3c80-539a-11eb-8f2e-2cf1c548cc14.png)

<br>

### ğŸ“œPlayerController

```c#
using UnityEngine.AI; // âœ¨

	void UpdateMoving()
	{
		Vector3 dir = _destPos - transform.position;
		if (dir.magnitude < 0.1f)  
		{
			_state = PlayerState.Idle;
		}
		else
		{
			NavMeshAgent nma = gameObject.GetOrAddComponent<NavMeshAgent>();
			float moveDist = Mathf.Clamp(_speed * Time.deltaTime, 0, dir.magnitude);
			nma.Move(dir.normalized * moveDist); // ì •ë°€ë„ ìˆê²Œ ì™„ì „ ê°€ê¹Œì´ê¹Œì§€ ì´ë™ì‹œì¼œì£¼ì§„ ì•ŠìŒ

			Debug.DrawRay(transform.position, dir.normalized, Color.green);
			if (Physics.Raycast(transform.position + Vector3.up * 0.5f, dir, 1.0f, LayerMask.GetMask("Block")))
            {
				_state = PlayerState.Idle;
				return;
            }

			//transform.position += dir.normalized * moveDist;
			transform.rotation = Quaternion.Slerp(transform.rotation, Quaternion.LookRotation(dir), 20 * Time.deltaTime);
		}

		// ì• ë‹ˆë©”ì´ì…˜
		Animator anim = GetComponent<Animator>();
		// í˜„ì¬ ê²Œì„ ìƒíƒœì— ëŒ€í•œ ì •ë³´ë¥¼ ë„˜ê²¨ì¤€ë‹¤
		anim.SetFloat("speed", _speed);
	}
```

ì§€ë¶•ì„ í´ë¦­í•œë‹¤ë©´ ì‚¬ì‹¤ ì§€ë¶• ìœ„ë¡œ ì˜¬ë¼ê°€ê²Œ í•˜ë ¤ëŠ”ê²Œ ì•„ë‹ˆë¼ ê·¸ ì§€ë¶• ë’¤ì— ê°€ë ¤ì§„ ê³µê°„ìœ¼ë¡œ ì´ë™ì‹œí‚¤ê² ë‹¤ëŠ” ì˜ë¯¸ì¸ë° Raycast ëŠ” ì§€ë¶•ì— ì¶©ëŒí•˜ì—¬ í”Œë ˆì´ì–´ê°€ ì§€ë¶•ìœ¼ë¡œ ìê¾¸ ì˜¬ë¼ê°€ë ¤ëŠ” ì‹œë„ë¥¼ í•˜ê²Œ ëœë‹¤. ì´ìƒí•¨! ì§€ê¸ˆ ì§€ë¶•ì€ "Ground"ë¡œ ì²˜ë¦¬ë˜ì–´ ìˆì–´ ë©”ì¸ ì¹´ë©”ë¼ì—ì„œ ì˜ëŠ” Raycastì™€ ì¶©ëŒí•˜ê¸° ë•Œë¬¸ì´ë‹¤. ë”°ë¼ì„œ ë‹¤ì‹œ ì§€ë¶•ì˜ ë ˆì´ì–´ë¥¼ "Ground" ë ˆì´ì–´ë¥¼ "Block"ë¡œ ë°”ê¿¨ë‹¤. ê·¸ëŸ¼ ì´ì œ ì§€ë¶•ì´ Raycast ì•ˆ ë§ê³  ì§€ë¶• ë’¤ì— ê°€ë ¤ì§„ ë•…ì´ Raycastë¥¼ ë§ì„ ê²ƒì´ë‹¤. Terrainë§Œ "Ground" Raycastë¥¼ ë°›ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ! ê·¸ë˜ë„ ì§‘ì„ í´ë¦­í•˜ë©´ í”Œë ˆì´ì–´ê°€ ì§‘ìœ¼ë¡œ ê³„ì† ê°€ë ¤ê³  ì‹œë„ë¥¼ í•œë‹¤ë©´ ì§‘ ë‚´ë¶€ê°€ NavMesh ë¡œ ê°ˆ ìˆ˜ ìˆëŠ” ì§€ì—­ìœ¼ë¡œ ì¸ì‹ëœ ê²ƒì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì§‘ ì˜¤ë¸Œì íŠ¸ë¥¼ í•œë²ˆ ì¹˜ì›Œì„œ ì§‘ ë‚´ë¶€ì— íŒŒë€ ê¸¸ì´ ìˆëŠ”ì§€ë¥¼ í™•ì¸í•´ë³´ì. ì´ëŸ° ê²½ìš°ì—” ì–´ì©” ìˆ˜ì—†ì´ í”Œë ˆì´ì–´ë¡œë¶€í„° Raycast ë¥¼ ì´ì„œ ì¶©ëŒë˜ëŠ” ê³³ì´ ìˆë‹¤ë©´ ëª» ê°€ê²Œë” í•˜ëŠ” ì‹ìœ¼ë¡œ êµ¬í˜„í•´ì•¼ ê² ë‹¤. **ì§ë¹µìœ¼ë¡œ ê°ˆ ìˆ˜ ì—†ëŠ” ê³³ì´ë¼ë©´ ëŒì•„ì„œ ëª©ì ì§€ì— ê°€ê²Œë” ê·¸ëŸ° ê¸¸ì°¾ê¸° ì‹œìŠ¤í…œì„ ì ìš©í•˜ëŠ” ê²ƒë„ ì¢‹ì€ ê²½í—˜ì´ ë  ê²ƒ ê°™ë‹¤.** 

- í”Œë ˆì´ì–´ê°€ `Idle` ë˜ëŠ” ë‘ê°€ì§€ ì¡°ê±´
  - *if (dir.magnitude < 0.1f)* ğŸ‘‰ ë„ì°©
    - ëª©ì ì§€ì™€ 0.1 ì •ë„ ë°–ì— ì°¨ì´ ì•ˆë‚  ë•ŒëŠ” ë„ì°©í–ˆë‹¤ê³  ì¸ì‹í•˜ê³  `Idle` ì¬ìƒ
    - ì›ë˜ 0.0001f ë¡œ í–ˆì—ˆëŠ”ë° `NavMeshAgent`ì˜ *Move* í•¨ìˆ˜ëŠ” ê·¸ë ‡ê²Œ ì •ë°€í•˜ê²Œê¹Œì§€ ì´ë™ì‹œì¼œì£¼ì§€ëŠ” ì•ŠëŠ”ë‹¤. íŒŒë€ìƒ‰ìœ¼ë¡œ êµ¬ì›Œì§„ ê¸¸ë§Œ ì´ë™í•  ìˆ˜ ìˆì–´ì„œì¸ì§€.. ê·¸ë˜ì„œ 0.1fë¡œ ì˜¬ë ¤ì¤€ë‹¤.
  - ë„ì°©í•œê±´ ì•„ë‹ˆë”ë¼ë„ í”Œë ˆì´ì–´ë¡œë¶€í„° 1.0f ê±°ë¦¬ì— Raycastë¥¼ ìˆì„ ë–„ "Block" ë ˆì´ì–´ë¥¼ ê°€ì§„ ì˜¤ë¸Œì íŠ¸ì™€ ì¶©ëŒí•  ë•Œ. 
    ```c#
    if (Physics.Raycast(transform.position + Vector3.up * 0.5f, dir, 1.0f, LayerMask.GetMask("Block")))
    ```


***
<br>

    ğŸŒœ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ í‹€ë¦° ë¶€ë¶„ì´ ìˆì„ ê²½ìš° 
    ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ì§€ì í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}