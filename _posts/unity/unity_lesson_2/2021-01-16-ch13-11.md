---
title:  "Chapter 13-11. ë¯¸ë‹ˆ RPG : ëª¬ìŠ¤í„° ìë™ ë¦¬ìŠ¤í°" 

categories:
  -  Unity Lesson 2
tags:
  - [Game Engine, Unity]

toc: true
toc_sticky: true

date: 2021-01-16
last_modified_at: 2021-01-16
---

ì¸í”„ëŸ°ì— ìˆëŠ” Rookissë‹˜ì˜ **[C#ê³¼ ìœ ë‹ˆí‹°ë¡œ ë§Œë“œëŠ” MMORPG ê²Œì„ ê°œë°œ ì‹œë¦¬ì¦ˆ] Part3: ìœ ë‹ˆí‹° ì—”ì§„** ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ í•„ê¸°ì…ë‹ˆë‹¤. ğŸ˜€  
[ğŸŒœ ê°•ì˜ ë“¤ìœ¼ëŸ¬ ê°€ê¸° Click](https://www.inflearn.com/course/MMORPG-ìœ ë‹ˆí‹°)
{: .notice--warning}


# Chapter 13. ë¯¸ë‹ˆ RPG ë§Œë“¤ê¸°

## ğŸš€ ëª¬ìŠ¤í„° ìë™ ë¦¬ìŠ¤í°

**ì„œë²„ ì¸¡ì—ì„œ í•œë‹¤.** ëª¬ìŠ¤í„°ê°€ ì£½ìœ¼ë©´ ëª¬ìŠ¤í„°ì˜ ì „ì²´ì ì¸ ìˆ«ìë¥¼ ë§ì¶°ì£¼ê¸° ìœ„í•´ **ëœë¤í•œ ìœ„ì¹˜ì—ì„œ ìŠ¤í°**ì„ í•œë‹¤. ì´ë ‡ê²Œ ì„œë²„ì¸¡ì—ì„œ ìŠ¤í°ì„ í•œ í›„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•Œë ¤ì¤€ë‹¤.

### ğŸ“œ GameManager

```c#
    public Action<int> OnSpawnEvent;

    public GameObject Spawn(Define.WorldObject type, string path, Transform parent = null)
    {
        GameObject go = Managers.Resource.Instantiate(path, parent);

        switch(type)
        {
            case Define.WorldObject.Monster:
                _monsters.Add(go);
                if (OnSpawnEvent != null)
                    OnSpawnEvent.Invoke(1);
                break;
            case Define.WorldObject.Player:
                _player = go;
                break;
        }

        return go;
    }

    public void Despawn(GameObject go)
    {
        Define.WorldObject type = GetWorldObjectType(go);

        switch(type)
        {
            case Define.WorldObject.Monster:
                {
                    if (_monsters.Contains(go))
                    {
                        _monsters.Remove(go);
                        if (OnSpawnEvent != null)
                            OnSpawnEvent.Invoke(-1);
                    }
                }
                break;
            case Define.WorldObject.Player:
                {
                    if (_player == go)
                        _player = null;
                }     
                break;
        }

        Managers.Resource.Destroy(go);
    }
```
```c#
                if (OnSpawnEvent != null)
                    OnSpawnEvent.Invoke(1);
                
                //...

                if (OnSpawnEvent != null)
                    OnSpawnEvent.Invoke(-1);
```


- `OnSpawnEvent`
  - ì´ ì•¡ì…˜ì— ì–´ë–¤ í•¨ìˆ˜ë“¤ì´ ë“±ë¡ë˜ì–´ ìˆì„ì§„ ëª¨ë¥´ê²Ÿì§€ë§Œ! ëª¬ìŠ¤í„°ë¥¼ ìŠ¤í°í•  ë•Œ, ë””ìŠ¤í°í•  ë•Œ ì´ ì•¡ì…˜ì„ ì‹¤í–‰í•œë‹¤.
  - ì´ ì•¡ì…˜ì—ëŠ” <u>íŒŒë¼ë¯¸í„°ë§Œí¼ ëª¬ìŠ¤í„°ë¥¼ ì¦ê°€ì‹œí‚¤ëŠ” í•¨ìˆ˜</u>ê°€ ë“±ë¡ë  ê²ƒì´ë‹¤.
    - ìŠ¤í°ì‹œ ğŸ‘‰ ëª¬ìŠ¤í„° 1ë§ˆë¦¬ ì¦ê°€ *OnSpawnEvent.Invoke(1);*
    - ë””ìŠ¤í°ì‹œ ğŸ‘‰ ëª¬ìŠ¤í„° 1ë§ˆë¦¬ ê°ì†Œ *OnSpawnEvent.Invoke(-1);*


<br>


### ğŸ“œ SpawningPool

```c#
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.AI;

public class SpawningPool : MonoBehaviour
{
    [SerializeField] int _monsterCount = 0;     // í˜„ì¬ ëª¬ìŠ¤í„° ìˆ˜
    [SerializeField] int _keepMonsterCount = 0; // ì›”ë“œ ìƒì— ìœ ì§€ë˜ì•¼ í•˜ëŠ” ëª¬ìŠ¤í„° ìˆ˜
    int _reserveCount = 0;  // ReserveSpawn ì½”ë£¨í‹´ í•¨ìˆ˜ ë‹¹ ê³§ ìƒì„±í•  ëª¬ìŠ¤í„° ìˆ˜

    [SerializeField] Vector3 _spawnPos;
    [SerializeField] float _spawnRadius = 15.0f;
    [SerializeField] float _spawnTime = 5.0f;

    public void AddMonsterCount(int value) { _monsterCount += value; }
    public void SetKeepMonsterCount(int count) { _keepMonsterCount += count; }


    void Start()
    {
        Managers.Game.OnSpawnEvent -= AddMonsterCount;
        Managers.Game.OnSpawnEvent += AddMonsterCount;
    }

    void Update()
    {
        while (_reserveCount + _monsterCount < _keepMonsterCount)
        {
            StartCoroutine(ReserveSpawn());
        }
    }

    IEnumerator ReserveSpawn()
    {
        _reserveCount++;
        yield return new WaitForSeconds(Random.Range(0, _spawnTime));
        GameObject obj = Managers.Game.Spawn(Define.WorldObject.Monster, "Knight");

        Vector3 randPos;
        NavMeshAgent nma = obj.GetOrAddComponent<NavMeshAgent>();
        while(true)
        {
            Vector3 randDir = Random.insideUnitSphere * Random.Range(0, _spawnRadius);
            randDir.y = 0;
            randPos = _spawnPos + randDir;

            NavMeshPath path = new NavMeshPath();
            if (nma.CalculatePath(randPos, path))
                break;
        }

        obj.transform.position = randPos;
        _reserveCount--;
    }
}
```

- *AddMonsterCount* : ëª¬ìŠ¤í„°ë¥¼ íŒŒë¼ë¯¸í„°ë§Œí¼ ëˆ„ì  ì¦ê°€ì‹œí‚¤ê¸° ìœ„í•´ `_monsterCount` ì—…ëƒ
  - ê²Œì„ ì‹œì‘ì‹œ ğŸ“œGameManagerì˜ `OnSpawnEvent`ì— ë“±ë¡
- *SetKeepMonsterCount* : ëª¬ìŠ¤í„°ë¥¼ íŒŒë¼ë¯¸í„°ë§Œí¼ ì¦ê°€ì‹œí‚¤ê¸° ìœ„í•´ `_keepMonsterCount` ì—…ëƒ
- *Update*
  - `monsterCount`ê°€ `keepMonsterCount`ì— ë‹¤ë‹¤ë¥¼ ë–„ê¹Œì§€ ëª¬ìŠ¤í„° ìƒì„±
    - `reserveCount`ê°€ ì“°ì´ëŠ” ì´ìœ ëŠ” ì•„ë˜ì—.
- *ReserveSpawn* 
  - ì´ ì½”ë£¨í‹´ í•¨ìˆ˜ëŠ” *í•œ ë§ˆë¦¬ì˜ ëª¬ìŠ¤í„°* ìŠ¤í°ì„ ìœ„í•œ í•¨ìˆ˜ë‹¤. ëœë¤ìœ¼ë¡œ 0 ~ `_spawnTime` ì‹œê°„ ë‚´ì˜ 1ï¸âƒ£ ëœë¤í•œ ì‹œê°„ì„ "ëŒ€ê¸°"í•œ í›„ì— 2ï¸âƒ£ ëª¬ìŠ¤í„°ë¥¼ ìƒì„±í•˜ê³  3ï¸âƒ£ ìŠ¤í°ëœ ëª¬ìŠ¤í„°ì˜ ìœ„ì¹˜ë¥¼ ëœë¤í•˜ê²Œ ì„¸íŒ…í•˜ëŠ” í•¨ìˆ˜ë‹¤.
    - `_reserveCount` 1 ì¦ê°€  
      - `_reserveCount`ì„ ì¦ê°€ì‹œí‚¤ëŠ” ì´ìœ 
        - ì´ ì½”ë£¨í‹´ì´ `yield return`ì„ í•œ í›„ WaitForSecondsë¡œ ì¸í•˜ì—¬ ëŒ€ê¸°í•˜ëŠ” ì‹œê°„ ë™ì•ˆ ì½”ë£¨í‹´ì˜ í˜¸ì¶œì ì´ì˜€ë˜ *Update*ì˜ whileë¬¸ì´ ë§ˆì € ì‹¤í–‰ëœë‹¤. (<u>ì½”ë£¨í‹´ì€ ëŒ€ê¸° ì‹œê°„ë™ì•ˆ ì½”ë£¨í‹´ í˜¸ì¶œì ì„ ë§ˆì € ì‹¤í–‰í•œë‹¤. ê·¸ë¦¬ê³  ëŒ€ê¸° ì‹œê°„ì´ ë‹¤ ëë‚˜ë©´ ë‹¤ì‹œ ì½”ë£¨í‹´ í•¨ìˆ˜ ë‚´ë¶€ë¡œ ëŒì•„ì˜¨ë‹¤.</u>) 
        - `_monsterCount`ëŠ” ëŒ€ê¸°ì‹œê°„ì„ ê°€ì§„ ì´í›„ì— ğŸ“œGameManagerì˜ *Spawn* í•¨ìˆ˜ì˜ *OnSpawnEvent.Invoke*ì„ í†µí•´ ì„¸íŒ…ëœë‹¤. ë”°ë¼ì„œ ğŸ“œSpawningPoolì˜ *Update*ì˜ *while* ë¬¸ì—ì„œëŠ” ì•„ì§ ì´  
        - ë”°ë¼ì„œ ëŒ€ê¸°ì‹œê°„ì„ ê°€ì§€ëŠ” ë™ì•ˆ ì½”ë£¨í‹´ì„ ë‚˜ì™€ whileë¬¸ì„ ë‹¤ì‹œ ì‹¤í–‰í•  ë•ŒëŠ” `_monsterCount`ê°€ ì•„ì§ 1 ì¦ê°€ê°€ ë˜ì§€ ì•Šì€ ìƒíƒœì´ê¸° ë•Œë¬¸ì— whileë¬¸ì´ ë¬´í•œ ë£¨í”„ë¡œ ëŒê²Œ ëœë‹¤. *_monsterCount < _keepMonsterCount* ì´ ì¡°ê±´ì´ ë§Œì¡±í•˜ë‹ˆê¹Œ *ReserveSpawn* ì„ ë˜ í˜¸ì¶œ í•˜ê³  ë˜ í˜¸ì¶œí•˜ê³ .. ëŒ€ê¸° ì‹œê°„ë™ì•ˆ *ReserveSpawn* ì„ ì—„ì²­ ë§ì´ í˜¸ì¶œí•˜ê²Œ ë  ê²ƒì´ë‹¤. 
        - ë”°ë¼ì„œ ì•„ì§ ì¦ê°€ë˜ê¸° ì „ì¸ `_monsterCount`ì„ 1 ì¦ê°€ í›„ë¡œ ë°˜ì˜í•˜ì—¬ whileë¬¸ ì¡°ê±´ì— ë„£ê¸° ìœ„í•´ `_reserveCount`ë¥¼ 1ë¡œ ì„¸íŒ…í•˜ê³  whileë¬¸ ì¡°ê±´ì„ *while (_reserveCount + _monsterCount < _keepMonsterCount)*ë¡œ í•´ì£¼ëŠ” ê²ƒì´ë‹¤!
        - ì´ëŸ¬ë©´ ì¦ê°€ë˜ì•¼ í•˜ëŠ” ìˆ˜ë§Œí¼ë§Œ *ReserveSpawn* ì½”ë£¨í‹´ í•¨ìˆ˜ê°€ í˜¸ì¶œì´ ë  ìˆ˜ ìˆë‹¤.
    - ëœë¤í•œ ëŒ€ê¸° ì‹œê°„ ê°€ì§€ê¸°
    - ëª¬ìŠ¤í„° ìŠ¤í°  ğŸ“œGameManagerì˜ *Spawn* í˜¸ì¶œ
    - ìŠ¤í°í•œ ëª¬ìŠ¤í„°ë¥¼ ëœë¤í•œ ìœ„ì¹˜ë¡œ ì„¤ì • (= ëœë¤í•œ ìœ„ì¹˜ì— ìŠ¤í°)
      - <u>ëœë¤ìœ¼ë¡œ ë½‘ì€ ìœ„ì¹˜ê°€ ê°ˆ ìˆ˜ ìˆëŠ” ê³³ìœ¼ë¡œ ë‚˜ì˜¬ ë•Œê¹Œì§€ ëœë¤ ë½‘ê¸°</u>
        - ëœë¤ ìœ„ì¹˜ ë½‘ê¸°
          - *Random.insideUnitSphere* 
            - (0, 0, 0) ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°˜ì§€ë¦„ 1 ì˜ ë°˜ê²½ ì›ì—ì„œ ëœë¤í•œ Vector3 ê°’ì„ ë¦¬í„´í•¨
          - 2D ê²Œì„ì´ë¯€ë¡œ ëœë¤ `y`ê°’ì€ ë°˜ì˜ X (ì´ë ‡ê²Œ ì•ˆí•´ì£¼ë©´ í•˜ëŠ˜ì´ë‚˜ ë•…ì—ì„œ ìŠ¤í°ë  ìˆ˜ë„ ìˆëŠ” ê²ƒì´ë‹¤. ã… )
        - ë½‘ì€ ìœ„ì¹˜ê°€ ê°ˆ ìˆ˜ ìˆëŠ” ê³³ì¸ì§€
          - *nma.CalculatePath(randPos, path)* ê°€ True ì´ë©´ ëœë¤ë½‘ê¸° ê·¸ë§Œ í•˜ê³  break.
    - ë‹¤ì‹œ `_reserveCount` 1 ê°ì†Œ

<br>


### ğŸ“œ GameScene    

```c#
public class GameScene : BaseScene
{
    protected override void Init()
    {
        //...

        //Managers.Game.Spawn(Define.WorldObject.Monster, "Knight");
        GameObject go = new GameObject { name = "SpawningPool" };
        SpawningPool pool = go.GetOrAddComponent<SpawningPool>();
        pool.SetKeepMonsterCount(5);
    }
```

"GameScene"ì”¬ì´ ì‹œì‘ë˜ë©´ "SpawningPool" ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ì´ì— ğŸ“œSpawningPool ë¥¼ ë°”ë¡œ ë¶™ì¸ë‹¤. ê·¸ë¦¬ê³  ëª¬ìŠ¤í„°ëŠ” 5 ë§ˆë¦¬ë¥¼ ìœ ì§€í•˜ë„ë¡ *SetKeepMonsterCount(5)* í˜¸ì¶œ.


<br>

## ğŸš€ ìˆ˜ì§ìœ¼ë¡œ ì´ë™í•˜ë ¤ëŠ” ë²„ê·¸ ê³ ì¹¨

### ğŸ“œPlayerController

```c#
	protected override void UpdateMoving()
	{
		// ëª¬ìŠ¤í„°ê°€ ë‚´ ì‚¬ì •ê±°ë¦¬ë³´ë‹¤ ê°€ê¹Œìš°ë©´ ê³µê²©
        //...

		// ì´ë™
		Vector3 dir = _destPos - transform.position;
		dir.y = 0;
		
```

í´ë¦­ ìœ„ì¹˜ì— ë”°ë¼ `y`ì¢Œí‘œë„ ë°˜ì˜ë  ìˆ˜ ìˆë‹¤. ëª©í‘œ ë°©í–¥ì¸ `dir`ì— `y`ê¹Œì§€ í¬í•¨ë˜ë©´ í”Œë ˆì´ì–´ê°€ ì¡°ê¸ˆ ë¶• ëœ° ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— `dir.y`ì€ ë°˜ì˜í•˜ì§€ ì•Šë„ë¡ 0 ìœ¼ë¡œ ì„¸íŒ…í•œë‹¤.


<br>


## â¤ ì™„ê°•

ì´ ê¸€ì„ ë³´ì‹œëŠ” ë¶„ì´ ê³„ì‹œë‹¤ë©´..  ì¸í”„ëŸ°ì—ì„œ ì´ ê°•ì˜ë¥¼ ê¼­ ë“¤ì–´ë³´ì‹œê¸°ë¥¼ ì¶”ì²œë“œë¦¬ê³  ì‹¶ìŠµë‹ˆë‹¤. ë‹¨ìˆœíˆ ìœ ë‹ˆí‹° ì—”ì§„ ì‚¬ìš©ë²•ë§Œì„ ìµíˆëŠ” ê²ƒì— ê·¸ì¹˜ì§€ ì•Šê³  í”„ë ˆì„ì›Œí¬ë¥¼ êµ¬ì¶•í•˜ëŠ” ì½”ë“œë¥¼ ì§œê¸° ë•Œë¬¸ì— ë”ìš± ë” ëª…ê°•ì˜ë¼ê³  ìƒê°í•©ë‹ˆë‹¤. ğŸ˜­ ê°•ì¶”.. 

***
<br>

    ğŸŒœ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ í‹€ë¦° ë¶€ë¶„ì´ ìˆì„ ê²½ìš° 
    ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ì§€ì í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}