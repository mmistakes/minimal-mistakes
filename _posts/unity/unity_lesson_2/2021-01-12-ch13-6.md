---
title:  "Chapter 13-6. λ―Έλ‹ RPG : κ³µκ²©" 

categories:
  -  Unity Lesson 2
tags:
  - [Game Engine, Unity]

toc: true
toc_sticky: true

date: 2021-01-12
last_modified_at: 2021-01-12
---

μΈν”„λ°μ— μλ” Rookissλ‹μ **[C#κ³Ό μ λ‹ν‹°λ΅ λ§λ“λ” MMORPG κ²μ„ κ°λ° μ‹λ¦¬μ¦] Part3: μ λ‹ν‹° μ—”μ§„** κ°•μλ¥Ό λ“£κ³  μ •λ¦¬ν• ν•„κΈ°μ…λ‹λ‹¤. π€  
[π κ°•μ λ“¤μΌλ¬ κ°€κΈ° Click](https://www.inflearn.com/course/MMORPG-μ λ‹ν‹°)
{: .notice--warning}


# Chapter 13. λ―Έλ‹ RPG λ§λ“¤κΈ°

## π€ μ„Έν…

### π“CursorController

> μ»¤μ„μ— κ΄€λ ¨λ λ¶€λ¶„μ„ λ”°λ΅ λΉΌμ„ μ΄μ‚¬μ‹ν‚΄

```c#
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class CursorController : MonoBehaviour
{
	int _mask = (1 << (int)Define.Layer.Ground) | (1 << (int)Define.Layer.Monster);

	Texture2D _attackIcon;
	Texture2D _handIcon;

	enum CursorType
	{
		None,
		Attack,
		Hand,
	}

	CursorType _cursorType = CursorType.None;

	void Start()
    {
		_attackIcon = Managers.Resource.Load<Texture2D>("Textures/Cursor/Attack");
		_handIcon = Managers.Resource.Load<Texture2D>("Textures/Cursor/Hand");
	}

    void Update()
    {
		if (Input.GetMouseButton(0))
			return;

		Ray ray = Camera.main.ScreenPointToRay(Input.mousePosition);

		RaycastHit hit;
		if (Physics.Raycast(ray, out hit, 100.0f, _mask))
		{
			if (hit.collider.gameObject.layer == (int)Define.Layer.Monster)
			{
				if (_cursorType != CursorType.Attack)
				{
					Cursor.SetCursor(_attackIcon, new Vector2(_attackIcon.width / 5, 0), CursorMode.Auto);
					_cursorType = CursorType.Attack;
				}
			}
			else
			{
				if (_cursorType != CursorType.Hand)
				{
					Cursor.SetCursor(_handIcon, new Vector2(_handIcon.width / 3, 0), CursorMode.Auto);
					_cursorType = CursorType.Hand;
				}
			}
		}
	}
}
```

<br>

### π“GameScene

```c#
public class GameScene : BaseScene
{
    protected override void Init()
    {
        //...
        gameObject.GetOrAddComponent<CursorController>();
```

<br>

## π€ κ³µκ²©ν•κΈ°

- λ³΄μ¤λ¥Ό ν• λ²λ§ ν΄λ¦­ν•λ©΄ π‘‰ ν• λ²λ§ λ•λ¦Ό
- λ³΄μ¤λ¥Ό ν• λ² ν΄λ¦­ν• μƒνƒμ—μ„ μ•λ–Όκ³  κ³„μ† λ„λ¥΄κ³  μλ” μƒνƒ π‘‰ λ³΄μ¤μ—κ² λ‹¬λ ¤κ°€μ„ λ§μ°μ¤λ¥Ό λ—„ λ•κΉμ§€ κ³„μ† λ•λ¦Ό

### β κ³µκ²© μ• λ‹λ©”μ΄μ… 

![image](https://user-images.githubusercontent.com/42318591/104286725-cba2d180-54f8-11eb-893b-44d4fdb17c69.png)

κ³µκ²© μ• λ‹λ©”μ΄μ…μ΄ μ¬μƒμ΄ μ–Όμ¶” λκ³ λ‚μ„ λ‹¤μ‹ μ¬μƒν•κ²λ” ν…€μ„ μ£Όμ–΄μ•Ό ν•λ‹¤. κ²μ† ν΄λ¦­ν•λ©΄ κ³µκ²© μ• λ‹λ©”μ΄μ…μ΄ κ·Έ ν΄λ¦­μ— λ§μ¶° μƒλ΅­κ² μ¬μƒλμ„ λ¶€μμ—°μ¤λ½κ³  μ΄μƒν•  κ²ƒμ΄λ‹¤. (μΉΌμ„ νλ‘λ¥΄κΈ° μ‹μ‘ν•λ” μ¥λ©΄λ§ κ³„μ† μ¬μƒν•κ² λλ” λ¨μµμ΄ λ‚μ¬ κ²ƒμ΄λ‹¤.) κ·Έλ¦¬κ³  κ³µκ²© μ• λ‹λ©”μ΄μ… μ–Όμ¶” λλ‚κ°€λ©΄ κ³„μ† κ³µκ²©μ„ ν•΄λ„ λλ”κ±΄μ§€ λ©μ¶°μ•Ό ν•λ”κ±΄μ§€ μ• μ μμ–΄μ•Ό ν•λ‹¤. λ”°λΌμ„ κ³µκ²© μ• λ‹λ©”μ΄μ…μ΄ λλ‚κ°μ¦μλ¶€ν„° μ• λ‹λ©”μ΄μ…μ΄ μ¬μƒλ  μ μκ²λ” ν•΄μ•Ό ν•λ‹¤. μ• λ‹λ©”μ΄μ… λλ‚κ°€λ” μ¦μμ„ μ• μ μλ„λ΅ κ³µκ²© μ• λ‹λ©”μ΄μ… νμΌμ `Events` λ¶€λ¶„μ—μ„ μ• λ‹λ©”μ΄μ…μ΄ λλ‚κ° λ• μ¦μ "OnHitEvent"λ¥Ό λ°μƒμ‹ν‚¤λ„λ΅ ν•λ‹¤. κ·Έλ¬λ©΄ λ™μΌν• μ΄λ¦„μ OnHitEvent() λ¥Ό μ •μν•΄μ£Όλ©΄ μ΄ μ΄λ²¤νΈκ°€ λ°μƒν•  λ• μ΄ ν•¨μκ°€ μ‹¤ν–‰ν•  μ μκ² λλ‹¤.

- Apply Root Motion ν•΄μ ν•λ©΄ κ³µκ²© μ¤‘μ—λ„ μ΄λ™μ„ ν•μ§€ μ•λ”λ‹¤.
  - κ³µκ²© μ• λ‹λ©”μ΄μ… ν΄λ¦½ μμ²΄κ°€ μ΄λ™λ‰μ΄ μμ. Animation Controllerμ—μ„ μ΄λ¥Ό ν•΄μ ν•λ©΄ μ΄ μ• λ‹λ©”μ΄μ…μ μ΄λ™μ„ λ”°λΌκ°€μ§€ μ•κ² λ‹¤λ” μλ―Έκ°€ λλ‹¤.

<br>

#### π“PlayerController

```c#
bool _stopSkill = false;

	public PlayerState State // Stateλ¥Ό μ• λ‹λ©”μ΄μ…κ³Ό κ°™μ΄ κ΄€λ¦¬
	{
		get { return _state; }
		set
		{
			_state = value; // μƒνƒ μ„Έν…

            // μ• λ‹λ©”μ΄μ… μ¬μƒ
			Animator anim = GetComponent<Animator>();
			switch (_state)
			{
				case PlayerState.Die:
					break;
				case PlayerState.Idle:
					anim.CrossFade("WAIT", 0.1f);
					break;
				case PlayerState.Moving:
					anim.CrossFade("RUN", 0.1f);
					break;
				case PlayerState.Skill:
					anim.CrossFade("ATTACK", 0.1f, -1, 0f);
					break;
			}
		}
	}
```

- `_stopSkill`μ΄ trueλ©΄ κ³µκ²©μ„ λ©μ¶”κ² ν•  κ²ƒμ΄λ‹¤.
- `State`ν”„λ΅νΌν‹° π‘‰ μƒνƒ μ„Έν…κ³Ό μ• λ‹λ©”μ΄μ…μ€ κ±°μ ν• μ„ΈνΈ λ§λƒ¥ λ¶™μ–΄ μκ² λλ―€λ΅ μ•„μ μƒνƒ ν”„λ΅νΌν‹°λ¥Ό λ§λ“¤μ–΄μ„ μƒνƒ μ„Έν… μ•μ— μ• λ‹λ©”μ΄μ… μ¬μƒ μ½”λ“λ¥Ό λ„£μ–΄ λ‘μ΄ ν•¨κ» λ¶™μ–΄λ‹¤λ‹κ²λ” ν•λ‹¤.
  - μ΄λ°κ²ƒλ„ κµ‰μ¥ν μ μ©ν•  μ½”λ”© μ¤ν‚¬μΈ κ²ƒ κ°™λ‹¤. μƒνƒ μ„Έν… λ’¤μ—λ” ν•­μƒ μ• λ‹λ©”μ΄μ… μ¬μƒμ΄ λ’¤λ”°λ¥Έλ‹¤λ©΄ μƒνƒλ¥Ό ν”„λ΅νΌν‹°λ΅ λ§λ“¤μ–΄μ„ μ„Έν…μ‹ μ΄μ–΄μ„ μ• λ‹λ©”μ΄μ…μ΄ μ¬μƒλ  μ μλ„λ΅ ν•λ” κ²ƒ!
- μ• λ‹λ©”μ΄μ… μ¬μƒ  
  - *anim.CrossFade* 
    - *anim.Play* λ¥Ό λ¶€λ“λ½κ² ν•λ” κ²ƒμ΄λΌκ³  λ³΄λ©΄ λλ‹¤. λ¶€λ“λ½κ³  μμ—°μ¤λ½κ² λΈ”λ λ”©λλ“― μ• λ‹λ©”μ΄μ…μ΄ μ¬μƒλλ‹¤.
      - *anim.Play*λ¥Ό μ‚¬μ©ν•λ©΄ μ¬μƒν•  μ• λ‹λ©”μ΄μ… ν΄λ¦½μ΄ λ°”λ€” λ• λλ λκΈ°λ“―μ΄ λ°”λ€μ–΄ λ¶€μμ—°μ¤λ½λ‹¤. *anim.CrossFade* λ” μ• λ‹λ©”μ΄μ…μ΄ μ•„μ£Ό μμ—°μ¤λ½κ² λ°”λ€κ² λλ‹¤.
    - μ²« λ²μ§Έ μΈμ : μ¬μƒν•  ν΄λ¦½ μ΄λ¦„
    - λ‘ λ²μ§Έ μΈμ : μ§€μ—° μ‹κ°„ (λ‹¤μ μ• λ‹λ©”μ΄μ…μΌλ΅ λ°”λ€λ”λ° κ±Έλ¦¬λ” fade μ‹κ°„)
      - 0.1f λΌλ©΄ λ°”λ€” μ• λ‹λ©”μ΄μ…μ 10 %λ” λ¶€λ“λ½κ² μ• λ‹λ©”μ΄μ…μ΄ μ΄μ–΄μ§€λ”λ° μ“΄λ‹¤.
    - μ„Έ λ²μ§Έ μΈμ : layer. μ• λ‹λ©”μ΄μ… λ μ΄μ–΄
    - λ„¤ λ²μ§Έ μΈμ(normalizedTimeOffset) : μ• λ‹λ©”μ΄μ…μ μ¬μƒ μ‹μ‘ μ‹μ  (0~1 λΉ„μ¨)
      - 0.0f λ΅ μ„Έν…ν•λ©΄ λ‹¤μ‹ μ²μμΌλ΅ λμ•„κ°€ μ¬μƒν•λ‹¤. 
      - ν΄λ¦½μ `Loop Time`μ΄ μ²΄ν¬λμ–΄ μμ§€ μ•λ”λΌλ„ μ΄λ ‡κ² μ½”λ“λ΅ λ°λ³µ μ¬μƒ μ‹ν‚¬ μ μλ‹¤.
  - νλΌλ―Έν„° λ° Transsitionκ³Ό μ΅°κ±΄μ„ μ‚¬μ©ν•μ§€ μ•κ³  λ°”λ΅ μ• λ‹λ©”μ΄μ…μ„ μ¬μƒ μ‹ν‚¨ μ΄μ 
    - κ³µκ²© νλΌλ―Έν„°κ°€ false μ΄λ©΄ κ±Έμ„ μλ„ μκ³  λ›Έ μλ„ μλ‹¤. λ‘ μƒνƒκ°€ λ‹¤ κ°€λ¥ν•λ―€λ΅ λ μ• λ§¤ν•΄μ Έμ„ μ΄λ¥Ό κµ¬λ³„ν•  μ¤ν”Όλ“ νλΌλ―Έν„°κ°€ λ ν•„μ”ν• κ²ƒμ΄λ‹¤. μ΄λ°μ‹μΌλ΅ νλΌλ―Έν„°κ°€ λ§μ•„μ§€λ©΄ λ³µμ΅ν•λ‹¤.
    - μ°¨λΌλ¦¬ μ΄λ ‡κ² νλΌλ―Έν„°λ¥Ό κ°€μ§€κ³  ν•λ” Transition μ΅°κ±΄μΌλ΅ μ• λ‹λ©”μ΄μ…μ„ μ¬μƒ μ‹ν‚¤μ§€ μ•κ³  κ·Έλƒ¥ Play μ‹ν‚¤λ“― μ• λ‹λ©”μ΄μ… ν΄λ¦½μ„ μ¬μƒ λ”± μ‹ν‚¤λ”κ² λ” λ‚μ„ μ μλ‹¤! 
      - λ¶€λ“λ½κ² Play ν•λ” CrossFade μ‚¬μ©.

![image](https://user-images.githubusercontent.com/42318591/104303739-cd2ac480-550d-11eb-885c-a9e49c486042.png)

νΈλμ§€μ… λ‹¤ μ—†μ•°!


```c#
	void OnHitEvent()
	{
		Debug.Log("OnHitEvent");

		// TODO
		if (_stopSkill)
		{
			State = PlayerState.Idle;
		}
		else
		{
			State = PlayerState.Skill;
		}
	}
```

μ• λ‹λ©”μ΄μ… λλ‚κ° λ•μ¦ `_stopSkill` κ°’μ„ μ•λ ¤μ£Όμ–΄ Idleμ„ μ¬μƒν• μ§€ λ§μ € Skill κ³µκ²© ν• μ§€ κ²°μ •ν•  μ μλ„λ΅ ν•λ‹¤.

<br>

### π“PlayerController

```c#
	void UpdateMoving()
	{
		// λ¬μ¤ν„°κ°€ λ‚΄ μ‚¬μ •κ±°λ¦¬λ³΄λ‹¤ κ°€κΉμ°λ©΄ κ³µκ²©
		if (_lockTarget != null)
		{
			_destPos = _lockTarget.transform.position;
			float distance = (_destPos - transform.position).magnitude;
			if (distance <= 1)
			{
				State = PlayerState.Skill;
				return;
			}
		}
        // μ΄λ™ 
        // ...
    }
```

- *UpdateMoving*
  - μ΄λ™ν•λ‹¤κ°€ λ¬μ¤ν„°κ°€ λ‚΄ μ‚¬μ •κ±°λ¦¬λ³΄λ‹¤ κ°€κΉμ°λ©΄ κ³µκ²©ν•λ„λ΅ λ³€κ²½ν•΄μ•Ό ν•λ‹¤.
    - `_lockTarget`μ΄ nullμ΄ μ•„λ‹λΌλ”κ±΄ κ³µκ²©ν•΄μ•Ό ν•λ‹¤λ” μλ―Έ
      - `_destPos`μ™€ `distance`λ” κ³µκ²©ν•  λ¬μ¤ν„° κΈ°μ¤€μΌλ΅ μ„¤μ •
      - `distance`κ°€ 1 λ³΄λ‹¤ μ‘μΌλ©΄ κ³µκ²© κ°€λ¥ν•λ„λ΅ μƒνƒλ¥Ό λ³€κ²½
      - κ·Έλ¦¬κ³  μ΄λ™ μ•ν•λ„λ΅ κ³§μ¥ λΉ μ Έ λ‚μ¤κΈ°

```c#
	void Update()
    {
		switch (State)
		{
			case PlayerState.Die:
				UpdateDie();
				break;
			case PlayerState.Moving:
				UpdateMoving();
				break;
			case PlayerState.Idle:
				UpdateIdle();
				break;
			case PlayerState.Skill:
				UpdateSkill();
				break;
		}
	}

    void UpdateSkill()
	{
		if (_lockTarget != null)
		{
			Vector3 dir = _lockTarget.transform.position - transform.position;
			Quaternion quat = Quaternion.LookRotation(dir);
			transform.rotation = Quaternion.Lerp(transform.rotation, quat, 20 * Time.deltaTime);
		}
	}
```

- κ³µκ²© μƒνƒκ°€λλ©΄ μλ™μΌλ΅ *UpdateSkill*κ°€ μ‹¤ν–‰ λλ‹¤. 
  - ν”λ μ΄μ–΄κ°€ κ³µκ²© λ€μƒμ„ λ°”λΌλ³΄κ²λ” λ¶€λ“λ½κ² νμ „ν•λ‹¤!

```c#
    void OnMouseEvent(Define.MouseEvent evt)
	{
		switch (State)
		{
			case PlayerState.Idle:
				OnMouseEvent_IdleRun(evt);
				break;
			case PlayerState.Moving:
				OnMouseEvent_IdleRun(evt);
				break;
			case PlayerState.Skill:
				{
					if (evt == Define.MouseEvent.PointerUp)
						_stopSkill = true;
				}
				break;
		}
	}

    void OnMouseEvent_IdleRun(Define.MouseEvent evt)
	{
		switch (evt)
		{
            case Define.MouseEvent.PointerDown: // μ²μμΌλ΅ λ„λ¥Έ μκ°„
				{
					if (raycastHit)
					{
						_destPos = hit.point;
						State = PlayerState.Moving;
						_stopSkill = false;
                        //...
                    }
                }
			//..
			case Define.MouseEvent.PointerUp:  // 0.2μ΄ μ΄μƒ λ„λ¥΄λ‹¤κ°€ λ—μ„ λ•
				_stopSkill = true;
				break;
		}
```

- κ³µκ²© μ¤‘μΈλ° λ§μ°μ¤ λ–Όλ” μ΄λ²¤νΈκ°€ λ“¤μ–΄μ™”λ‹¤λ©΄ κ³µκ²© κ·Έλ§ν•΄μ•Ό ν•λ―€λ΅ `_stopSkill`μ΄ trueκ°€ λμ•Ό ν•λ‹¤.
- Idleμ΄κ±°λ‚ λ‹¬λ¦¬λ” μ¤‘μΈλ° 
  - μ²μμΌλ΅ λ§μ°μ¤λ¥Ό λλ €λ‹¤λ©΄ κ³µκ²©ν•΄μ•Ό ν•λ―€λ΅ `_stopSkill`μ΄ falseκ°€ λμ•Ό ν•λ‹¤.
  - λ§μ°μ¤λ¥Ό κΎΉ λ„λ¥΄λ‹¤κ°€ λ—λ‹¤λ©΄ κ³µκ²© κ·Έλ§ν•΄μ•Ό ν•λ―€λ΅ `_stopSkill`μ΄ trueκ°€ λμ•Ό ν•λ‹¤.


***
<br>

    π κ°μΈ κ³µλ¶€ κΈ°λ΅μ© λΈ”λ΅κ·Έμ…λ‹λ‹¤. μ¤λ¥λ‚ ν‹€λ¦° λ¶€λ¶„μ΄ μμ„ κ²½μ° 
    μ–Έμ λ“ μ§€ λ“κΈ€ νΉμ€ λ©”μΌλ΅ μ§€μ ν•΄μ£Όμ‹λ©΄ κ°μ‚¬ν•κ² μµλ‹λ‹¤! π„

[λ§¨ μ„λ΅ μ΄λ™ν•κΈ°](#){: .btn .btn--primary }{: .align-right}