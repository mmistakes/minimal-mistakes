---

layout: single
title: "[JPA í”„ë¡œê·¸ë˜ë°] 8. í”„ë¡ì‹œì™€ ì—°ê´€ê´€ê³„ ê´€ë¦¬"
toc: true
toc_sticky: true
toc_label: " "

---

## í”„ë¡ì‹œ

### í”„ë¡ì‹œë€

> â“ í…Œì´ë¸”ì„ ì¡°íšŒí•´ì„œ ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ ë•Œ ì—°ê´€ê´€ê³„ ê°ì²´ëŠ” ì•ˆ ê°€ì ¸ ì˜¤ê³  ì‹¶ìœ¼ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ?
> 

<img width="450" alt="image" src="https://user-images.githubusercontent.com/114092152/235614361-15fddd1a-9ff7-4a37-b6b7-02e6a7df1940.png">


- `em.find()` : ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í†µí•´ì„œ ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ì¡°íšŒ
- `em.getRefetence()` : ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒë¥¼ ë¯¸ë£¨ëŠ” ê°€ì§œ(**í”„ë¡ì‹œ**) ì—”í‹°í‹° ê°ì²´ ì¡°íšŒ

```java
Member m1 = em.find(Member.class, member1.getId());
Member m2 = em.getReference(Member.class, member2.getId());

System.out.println((m1 instanceof Member));
System.out.println((m2 instanceof Member));
```

- getReference() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ì§„ì§œ ê°ì²´ê°€ ì•„ë‹Œ í•˜ì´ë²„ë„¤ì´íŠ¸ ë‚´ë¶€ ë¡œì§ìœ¼ë¡œ í”„ë¡ì‹œ ì—”í‹°í‹° ê°ì²´ ë°˜í™˜
- ë‚´ë¶€ êµ¬ì¡° í‹€ì€ ê°™ì§€ë§Œ ë‚´ìš©ì´ ë¹„ì–´ìˆìŒ

<img width="450" alt="image" src="https://user-images.githubusercontent.com/114092152/235614437-c2371649-f81c-4bc8-bbfe-7ba680f2d93c.png">

### íŠ¹ì§•

<img width="450" alt="image" src="https://user-images.githubusercontent.com/114092152/235614463-da4fe626-1991-4ed5-92cc-fbde89518c25.png">

- ì‹¤ì œ í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ì•„ì„œ ë§Œë“¤ì–´ì§
- ì‹¤ì œ í´ë˜ìŠ¤ì™€ ê²‰ëª¨ì–‘ì´ ê°™ìŒ
- ì‚¬ìš©í•˜ëŠ” ì…ì¥ì—ì„œëŠ” ì§„ì§œ ê°ì²´ì¸ì§€ êµ¬ë¶„í•  í•„ìš”ê°€ X (ì´ë¡ ì ìœ¼ë¡œ)
- í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ ê°ì²´ì˜ ì°¸ì¡°(target)ë¥¼ ë³´ê´€
- í”„ë¡ì‹œ ê°ì²´ë¥¼ í˜¸ì¶œ(getName()) í•˜ë©´ í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ ê°ì²´ì˜ ë©”ì„œë“œ í˜¸ì¶œ

- í”„ë¡ì‹œëŠ” ì²˜ìŒ ì‚¬ìš©í•  ë•Œ í•œ ë²ˆë§Œ ì´ˆê¸°í™”
- í”„ë¡ì‹œ ê°ì²´ë¥¼ ì´ˆê¸°í™”í•  ë•Œ í”„ë¡ì‹œ ê°ì²´ê°€ ì‹¤ì œ ì—”í‹°í‹°ë¡œ ë°”ë€ŒëŠ” ê²ƒì€ ì•„ë‹˜, ì´ˆê¸°í™”ë˜ë©´ í”„ë¡ì‹œ ê°ì²´ë¥¼ í†µí•´ ì‹¤ì œ ì—”í‹°í‹°ì— ì ‘ê·¼ ê°€ëŠ¥
- í”„ë¡ì‹œ ê°ì²´ëŠ” ì›ë³¸ ì—”í‹°í‹°ë¥¼ ìƒì†ë°›ìŒ, ë”°ë¼ì„œ íƒ€ì… ì²´í¬ ì‹œ ì£¼ì˜í•´ì•¼ í•¨( == ë¹„êµ ì‹¤íŒ¨, ëŒ€ì‹  instance of ì‚¬ìš©)

```java
m1.getClass() == m2.getClass() //false
m1 instanceof Member // true
m2 instanceof Member // true
```

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì°¾ëŠ” ì—”í‹°í‹°ê°€ ì´ë¯¸ ìˆìœ¼ë©´ em.getReference()ë¥¼ í˜¸ì¶œí•´ë„ ì‹¤ì œ ì—”í‹°í‹° ë°˜í™˜

```java
Member m1 = em.find(Member.class, member1.getId());
System.out.println("m1 = "+ m1.getClass());//Member

Member reference = em.getReference(Member.class, member1.getId());
System.out.println("reference = " reference.getClass()); //Member

m1 == reference //true
```

â†’ ì´ë¯¸ Memberê°€ 1ì°¨ ìºì‹œì—ë„ ì˜¬ë¼ì™€ ìˆì§€ë§Œ í”„ë¡ì‹œ ë°˜í™˜í•  í•„ìš” X

- ë°˜ëŒ€ë¡œ getReference()ë¡œ í”„ë¡ì‹œê°ì²´ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ ì‹¤ì œë¡œ find()ë¥¼ í–ˆì„ ë•Œë„ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë°˜í™˜
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë„ì›€ì„ ë°›ì„ ìˆ˜ ì—†ëŠ” ì¤€ì˜ì† ìƒíƒœì¼ ë•Œ, í”„ë¡ì‹œë¥¼ ì´ˆê¸°í™”í•˜ë©´ ë¬¸ì œ ë°œìƒ

```java
Member refMember = em.getReference(Member.class, member.getId());
System.out.println("refMember = "+ refMember.getClass()); // Proxy

em.detach(refMember);  // em.clear

refMember.getUsername();
```

### í”„ë¡ì‹œ ê°ì²´ì˜ ì´ˆê¸°í™”

```java
Member member = em.getRefernce(Member.class, "id1");
member.getName();
```

<img width="450" alt="image" src="https://user-images.githubusercontent.com/114092152/235629285-2c0763fe-7518-4a98-98b0-a0230a7911a3.png">

- ì½”ë“œ ë¼ì¸ì—ì„œ `getReference()` ë¥¼ í˜¸ì¶œí•˜ë©´ í”„ë¡ì‹œ ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ ë‹¤ìŒ, `getName()` ì„ í˜¸ì¶œí•˜ë©´ JPAê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì´ˆê¸°í™” ìš”ì²­ì„ í•¨
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” ì‹¤ì œ dbë¥¼ ì¡°íšŒí•´ì„œ ê°€ì ¸ì˜¨ ë‹¤ìŒ ì‹¤ì œ Entityì— ê°’ì„ ë„£ì–´ ìƒì„±
- í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ Entityë¥¼ ì—°ê²°í•´ì„œ ì‹¤ì œ Entityë¥¼ ë°˜í™˜
- ê·¸ ì´í›„ì—ëŠ” ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ìˆëŠ” í”„ë¡ì‹œ ê°ì²´ì´ê¸°ì— í•´ë‹¹ Entityë¥¼ ë°˜í™˜

---

## ì¦‰ì‹œ ë¡œë”©ê³¼ ì§€ì—° ë¡œë”©

### ì§€ì—° ë¡œë”©

> â“ Memberë¥¼ ì¡°íšŒí•  ë•Œ Team(ì—°ê´€ê´€ê³„)ë„ í•¨ê»˜ ì¡°íšŒí•´ì•¼ í• ê¹Œ?
> 

â†’ ë‹¨ìˆœíˆ member ì •ë³´ë§Œ ì‚¬ìš©í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

> ì§€ì—° ë¡œë”© LAZYë¥¼ ì‚¬ìš©í•´ì„œ í”„ë¡ì‹œë¡œ ì¡°íšŒ
> 
> 
> `fetch = FetchType.LAZY`
> 

```java
@Entity
public class Member{
	
	@Id @GeneratedValue
	private Long id;
	
	@Column (name = "USERNAME")
	private String name;
	
	@ManyToOne(fetch = FetchType.LAZY) //ì§€ì—°ë¡œë”© ì‚¬ìš©
	@JoinColumn(name="TEAM_ID")
	private Team team;
	...
}
...
Member m = em.find(Member.class, member1.getId()); // Member ê°ì²´ ë°˜í™˜
System.out.println("m = "+ m.getTeam().getClass()); // Team$HibernateProxyê°ì²´ ë°˜í™˜
m.getTeam().getName() // teamì„ ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ì‹œì ì—ì„œ dbì¡°íšŒ ì—”í‹°í‹° ë°˜í™˜
...
```

- ì—°ê´€ê´€ê³„ì— ìˆëŠ” ë‹¤ë¥¸ ì—”í‹°í‹°ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¹ˆë„ìˆ˜ê°€ ë‚®ì„ ê²½ìš° ì§€ì—° ë¡œë”©ì„ ì‚¬ìš©í•´ ë¶ˆí•„ìš”í•œ ì—”í‹°í‹° ì¡°íšŒë¥¼ ë§‰ì„ ìˆ˜ ìˆìŒ

### ì¦‰ì‹œ ë¡œë”©

> â“ Memberë¥¼ Teamì„ ê°™ì´ ì“°ëŠ” ë¹ˆë„ê°€ ë†’ì„ ê²½ìš°ì—ëŠ” ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ?
> 

> ì§€ì—° ë¡œë”© EAGERë¥¼ ì‚¬ìš©í•´ì„œ í”„ë¡ì‹œë¡œ ì¡°íšŒ
> 
> 
> `fetch = FetchType.EAGER`
> 

```java
@Entity
public class Member{

	@Id @GeneratedValue
	private Long id;
	
	@Column (name = "USERNAME")
	private String name;
	
	@ManyToOne(fetch = FetchType.EAGER) // ì¦‰ì‹œë¡œë”© ì‚¬ìš©
	@JoinColumn(name="TEAM_ID")
	private Team team;
	...
}
...
Member m = em.find(Member.class, member1.getId()); // Member ê°ì²´ ë°˜í™˜
System.out.println("m = "+ m.getTeam().getClass()); // Team ê°ì²´ ë°˜í™˜
...
```

- Memberë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‹œì ì—ì„œ ì—°ê´€ê´€ê³„ì— ìˆëŠ” Teamê¹Œì§€ ë°”ë¡œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ì¦‰ì‹œ ë¡œë”©ì´ë¼ í•¨

### â—í”„ë¡ì‹œì™€ ì¦‰ì‹œ ë¡œë”© ì£¼ì˜

- ê°€ê¸‰ì  ì§€ì—° ë¡œë”©ë§Œ ì‚¬ìš©(íŠ¹íˆ ì‹¤ë¬´ì—ì„œ)
- ì¦‰ì‹œ ë¡œë”©ì„ ì ìš©í•˜ë©´ ì˜ˆìƒí•˜ì§€ ëª»í•œ SQLì´ ë°œìƒ
    
    *ex) í•˜ë‚˜ì˜ ì—”í‹°í‹°ì— ì—°ê´€ëœ ì—”í‹°í‹°ê°€ ë‹¤ìˆ˜ë¼ë©´ find() í•œ ë²ˆ ìˆ˜í–‰ ì‹œ ìˆ˜ì‹­ìˆ˜ë°± ê°œì˜ í…Œì´ë¸”ì„ í•œ ë²ˆì—~~*
    
- ì¦‰ì‹œ ë¡œë”©ì€ JQPLì—ì„œ N+1 ë¬¸ì œë¥¼ ì¼ìœ¼í‚´

### ğŸ’¡N+1ì˜ í•´ê²°ì±…

- ì „ë¶€ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •
    - `@ManyToOne`, `@OneToOne`ì€ ê¸°ë³¸ì´ ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ë˜ì–´ ìˆë‹¤. â†’ **ì§ì ‘ ì „ë¶€ LAZYë¡œ ì„¤ì •**
    - `@OneToMany`, `@ManyToMany`ëŠ” ê¸°ë³¸ì´ ì§€ì—° ë¡œë”©
- ê°€ì ¸ì™€ì•¼ í•˜ëŠ” ì—”í‹°í‹°ì— í•œí•´ì„œ fetch joinì„ ì‚¬ìš©í•´ì„œ ê°€ì ¸ì˜´

```java
List<Member> members = em.createQuery("select m from Member m fetch join m.team", Member.class)
				.getResultList();
```

- fetch joinì„ í†µí•´ Teamë„ ê°€ì ¸ì™”ê¸° ë•Œë¬¸ì— ë¬¸ì œ X

### ì§€ì—° ë¡œë”© í™œìš©

- Memberì™€ Team ì€ ìì£¼ í•¨ê»˜ ì‚¬ìš© â†’ ì¦‰ì‹œ ë¡œë”©
- Memberì™€ OrderëŠ” ê°€ë” ì‚¬ìš© â†’ ì§€ì—° ë¡œë”©
- Orderì™€ ProductëŠ” ìì£¼ í•¨ê»˜ ì‚¬ìš© â†’ ì¦‰ì‹œ ë¡œë”©

<img width="450" alt="image" src="https://user-images.githubusercontent.com/114092152/235629321-b0729c44-b6c7-476a-8fbc-165dacaab1ac.png">

> ì‹¤ë¬´
> 
- ëª¨ë“  ì—°ê´€ê´€ê³„ì— ì§€ì—° ë¡œë”©ì„ ì‚¬ìš©í•˜ì.
- ì‹¤ë¬´ì—ì„œ ì¦‰ì‹œ ë¡œë”©ì„ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.
- JPQL fetch ì¡°ì¸ì´ë‚˜, ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë¼.
- ì¦‰ì‹œ ë¡œë”©ì€ ë‚´ê°€ ì˜ë„í•˜ì§€ ì•Šì€ ì¿¼ë¦¬ê°€ ìˆ˜í–‰ëœë‹¤.

---

