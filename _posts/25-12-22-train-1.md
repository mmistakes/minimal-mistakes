{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "8c70c24f-16f0-4887-a368-ed1db7e74c2c",
   "metadata": {},
   "source": [
    "✅ 문제  \n",
    "1) 코딩  \n",
    "아래 규칙으로 결측치를 채워 df_filled를 만들어라. (원본 df는 변경하지 말 것)  \n",
    "glc, lac 각각에 대해  \n",
    "같은 batch 내에서 선형 보간(interpolate, 양방향 허용) 으로 결측치를 채운다.  \n",
    "단, batch의 맨 앞/맨 끝이 결측인 경우도 채워져야 한다.  \n",
    "df_filled에 아래 컬럼을 추가한 df_feat를 만들어라.  \n",
    "glc_delta = batch별로 glc의 전날 대비 변화량 (diff)  \n",
    "lac_delta = batch별로 lac의 전날 대비 변화량 (diff)  \n",
    "첫 day의 delta는 NaN이어도 된다.  \n",
    "2) 분석  \n",
    "batch별로 아래를 계산해 df_summary를 만들어라.  \n",
    "batch  \n",
    "glc_min : glc 최솟값  \n",
    "lac_max : lac 최댓값  \n",
    "num_days_glc_decrease : glc_delta < 0 인 day 개수 (NaN은 제외)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "3330241c-35fe-4957-9f93-1eb468e04b0a",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "\n",
    "df = pd.DataFrame({\n",
    "    \"batch\": [\"B1\",\"B1\",\"B1\",\"B2\",\"B2\",\"B2\",\"B3\",\"B3\",\"B3\"],\n",
    "    \"day\":   [1,2,3,1,2,3,1,2,3],\n",
    "    \"glc\":   [5.0, 4.2, None, 5.1, None, 4.0, None, 4.8, 4.4],\n",
    "    \"lac\":   [0.8, 1.1, 1.6, 0.7, 1.0, None, 0.9, None, 1.5]\n",
    "})"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "a3e57689-b07b-4d3b-80ae-a02c9140a541",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>batch</th>\n",
       "      <th>day</th>\n",
       "      <th>glc</th>\n",
       "      <th>lac</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>B1</td>\n",
       "      <td>1</td>\n",
       "      <td>5.0</td>\n",
       "      <td>0.8</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>B1</td>\n",
       "      <td>2</td>\n",
       "      <td>4.2</td>\n",
       "      <td>1.1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>B1</td>\n",
       "      <td>3</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.6</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>B2</td>\n",
       "      <td>1</td>\n",
       "      <td>5.1</td>\n",
       "      <td>0.7</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>B2</td>\n",
       "      <td>2</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>B2</td>\n",
       "      <td>3</td>\n",
       "      <td>4.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>B3</td>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.9</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>B3</td>\n",
       "      <td>2</td>\n",
       "      <td>4.8</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>B3</td>\n",
       "      <td>3</td>\n",
       "      <td>4.4</td>\n",
       "      <td>1.5</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  batch  day  glc  lac\n",
       "0    B1    1  5.0  0.8\n",
       "1    B1    2  4.2  1.1\n",
       "2    B1    3  NaN  1.6\n",
       "3    B2    1  5.1  0.7\n",
       "4    B2    2  NaN  1.0\n",
       "5    B2    3  4.0  NaN\n",
       "6    B3    1  NaN  0.9\n",
       "7    B3    2  4.8  NaN\n",
       "8    B3    3  4.4  1.5"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "display(df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "359b7ca2-7101-49e8-9110-7e21e824e1f1",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>batch</th>\n",
       "      <th>day</th>\n",
       "      <th>glc</th>\n",
       "      <th>lac</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>B1</td>\n",
       "      <td>1</td>\n",
       "      <td>5.00</td>\n",
       "      <td>0.8</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>B1</td>\n",
       "      <td>2</td>\n",
       "      <td>4.20</td>\n",
       "      <td>1.1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>B1</td>\n",
       "      <td>3</td>\n",
       "      <td>4.20</td>\n",
       "      <td>1.6</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>B2</td>\n",
       "      <td>1</td>\n",
       "      <td>5.10</td>\n",
       "      <td>0.7</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>B2</td>\n",
       "      <td>2</td>\n",
       "      <td>4.55</td>\n",
       "      <td>1.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>B2</td>\n",
       "      <td>3</td>\n",
       "      <td>4.00</td>\n",
       "      <td>1.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>B3</td>\n",
       "      <td>1</td>\n",
       "      <td>4.80</td>\n",
       "      <td>0.9</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>B3</td>\n",
       "      <td>2</td>\n",
       "      <td>4.80</td>\n",
       "      <td>1.2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>B3</td>\n",
       "      <td>3</td>\n",
       "      <td>4.40</td>\n",
       "      <td>1.5</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  batch  day   glc  lac\n",
       "0    B1    1  5.00  0.8\n",
       "1    B1    2  4.20  1.1\n",
       "2    B1    3  4.20  1.6\n",
       "3    B2    1  5.10  0.7\n",
       "4    B2    2  4.55  1.0\n",
       "5    B2    3  4.00  1.0\n",
       "6    B3    1  4.80  0.9\n",
       "7    B3    2  4.80  1.2\n",
       "8    B3    3  4.40  1.5"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_filled = df.copy()\n",
    "df_filled[['glc','lac']] = df_filled.groupby('batch')[['glc','lac']].transform(\n",
    "    lambda batch: batch.interpolate(method='linear', limit_direction='both'))\n",
    "display(df_filled)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "79fa7d7a-9339-48fc-be01-a55f708295f8",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>batch</th>\n",
       "      <th>day</th>\n",
       "      <th>glc</th>\n",
       "      <th>lac</th>\n",
       "      <th>glc_delta</th>\n",
       "      <th>lac_delta</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>B1</td>\n",
       "      <td>1</td>\n",
       "      <td>5.00</td>\n",
       "      <td>0.8</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>B1</td>\n",
       "      <td>2</td>\n",
       "      <td>4.20</td>\n",
       "      <td>1.1</td>\n",
       "      <td>-0.80</td>\n",
       "      <td>0.3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>B1</td>\n",
       "      <td>3</td>\n",
       "      <td>4.20</td>\n",
       "      <td>1.6</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0.5</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>B2</td>\n",
       "      <td>1</td>\n",
       "      <td>5.10</td>\n",
       "      <td>0.7</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>B2</td>\n",
       "      <td>2</td>\n",
       "      <td>4.55</td>\n",
       "      <td>1.0</td>\n",
       "      <td>-0.55</td>\n",
       "      <td>0.3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>B2</td>\n",
       "      <td>3</td>\n",
       "      <td>4.00</td>\n",
       "      <td>1.0</td>\n",
       "      <td>-0.55</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>B3</td>\n",
       "      <td>1</td>\n",
       "      <td>4.80</td>\n",
       "      <td>0.9</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>B3</td>\n",
       "      <td>2</td>\n",
       "      <td>4.80</td>\n",
       "      <td>1.2</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0.3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>B3</td>\n",
       "      <td>3</td>\n",
       "      <td>4.40</td>\n",
       "      <td>1.5</td>\n",
       "      <td>-0.40</td>\n",
       "      <td>0.3</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  batch  day   glc  lac  glc_delta  lac_delta\n",
       "0    B1    1  5.00  0.8        NaN        NaN\n",
       "1    B1    2  4.20  1.1      -0.80        0.3\n",
       "2    B1    3  4.20  1.6       0.00        0.5\n",
       "3    B2    1  5.10  0.7        NaN        NaN\n",
       "4    B2    2  4.55  1.0      -0.55        0.3\n",
       "5    B2    3  4.00  1.0      -0.55        0.0\n",
       "6    B3    1  4.80  0.9        NaN        NaN\n",
       "7    B3    2  4.80  1.2       0.00        0.3\n",
       "8    B3    3  4.40  1.5      -0.40        0.3"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "df_feat = df_filled.copy()\n",
    "df_feat = df_feat.reset_index().sort_values(by='day', ascending=False)\n",
    "df_feat['glc_delta'] = df_feat.groupby('batch')['glc'].diff(periods=1)\n",
    "df_feat['lac_delta'] = df_feat.groupby('batch')['lac'].diff(periods=1)\n",
    "display(df_feat)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "id": "7e8749e1-9102-4c0d-9520-8d129f76ecb4",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>glc_min</th>\n",
       "      <th>lac_max</th>\n",
       "      <th>num_days_glc_decrease</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>4.2</td>\n",
       "      <td>1.6</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>4.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>4.4</td>\n",
       "      <td>1.5</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   glc_min  lac_max  num_days_glc_decrease\n",
       "0      4.2      1.6                      1\n",
       "1      4.0      1.0                      2\n",
       "2      4.4      1.5                      1"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "def count_neg(x):\n",
    "    val = x < 0\n",
    "    result = sum(val)\n",
    "    return result\n",
    "df_summary = df_feat.groupby('batch').agg({'glc':[('glc_min', 'min')],'lac':[('lac_max','max')],'glc_delta':[('num_days_glc_decrease', count_neg)]})\n",
    "df_summary.columns = df_summary.columns.droplevel(level=0)\n",
    "df_summary = df_summary.reset_index(drop=True)\n",
    "display(df_summary)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "2cc3acd0-a5f8-4eca-aaec-99ccc2baef5e",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "(  batch  day   glc  lac\n",
       " 0    B1    1  5.00  0.8\n",
       " 1    B1    2  4.20  1.1\n",
       " 2    B1    3  4.20  1.6\n",
       " 3    B2    1  5.10  0.7\n",
       " 4    B2    2  4.55  1.0\n",
       " 5    B2    3  4.00  1.0\n",
       " 6    B3    1  4.80  0.9\n",
       " 7    B3    2  4.80  1.2\n",
       " 8    B3    3  4.40  1.5,\n",
       "   batch  glc_min  lac_max  num_days_glc_decrease\n",
       " 0    B1      4.2      1.6                      1\n",
       " 1    B2      4.0      1.0                      2\n",
       " 2    B3      4.4      1.5                      1)"
      ]
     },
     "execution_count": 31,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# 1) fill (keep original df unchanged)\n",
    "df_filled = df.copy()\n",
    "df_filled[[\"glc\", \"lac\"]] = (\n",
    "    df_filled.groupby(\"batch\")[[\"glc\", \"lac\"]]\n",
    "             .transform(lambda g: g.interpolate(method=\"linear\", limit_direction=\"both\"))\n",
    ")\n",
    "\n",
    "# enforce required sort\n",
    "df_filled = df_filled.sort_values([\"batch\", \"day\"]).reset_index(drop=True)\n",
    "\n",
    "# 2) features\n",
    "df_feat = df_filled.copy()\n",
    "df_feat[\"glc_delta\"] = df_feat.groupby(\"batch\")[\"glc\"].diff()\n",
    "df_feat[\"lac_delta\"] = df_feat.groupby(\"batch\")[\"lac\"].diff()\n",
    "\n",
    "# 3) summary (exact columns + batch as column)\n",
    "df_summary = (\n",
    "    df_feat.groupby(\"batch\", as_index=False)\n",
    "           .agg(\n",
    "               glc_min=(\"glc\", \"min\"),\n",
    "               lac_max=(\"lac\", \"max\"),\n",
    "               num_days_glc_decrease=(\"glc_delta\", lambda s: (s < 0).sum())\n",
    "           )\n",
    "           .sort_values(\"batch\")\n",
    "           .reset_index(drop=True)\n",
    ")\n",
    "\n",
    "df_filled, df_summary\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.9"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
