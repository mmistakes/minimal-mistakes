---
layout: single
title:  "[자바 ORM 표준] 다양한 연관관계 매핑"
categories: JPA
tag: [web, server, DB, JPA, spring boot]
toc: true
toc_sticky: true
author_profile: false
sidebar:
    nav: "docs"
---

<br>

**연관관계 매핑시 고려사항**
- 다중성
- 단방향, 양방향
- 연관관계의 주인

<br>

# 다중성

- 다대일: **@ManyToOne**
- 일대다: **@OneToMany**
- 일대일: **@OneToOne**
- 다대다: **@ManyToMany**

<br>

# 단방향, 양방향

- **테이블**
    - 외래 키 하나로 양쪽 조인 가능
    - 방향이라는 개념이 없음
- **객체**
    - 참조용 필드가 있는 쪽으로만 참조 가능
    - 한쪽만 참조하면 단방향
    - 양쪽이 서로 참조하면 양방향

<br>

# 연관관계의 주인

- 테이블은 **외래 키 하나**로 두 테이블이 연관관계를 맺음
- 객체 양방향 관계는 A -> B, B -> A 처럼 **참조가 2군데**
- 객체 양방향 관계는 참조가 2군데 있음. 둘중 테이블의 외래 키를 관리할 곳을 지정해야함
- 연관관계의 주인: 외래 키를 관리하는 참조
- 주인의 반대편: 외래 키에 영향을 주지 않음, 단순 조회만 가능

<br>

# 다대일 [N:1]

## 다대일 단방향

![19](/images/JPA_ORM/19.jpg)

- 가장 많이 사용하는 연관관계
- **다대일**의 반대는 **일대다**

## 다대일 양방향

![24](/images/JPA_ORM/24.jpg)

- 외래 키가 있는 곳이 연관관계의 주인
- 양쪽을 서로 참조하도록 개발

<br>

# 일대다 [1:N]

## 일대다 단방향

![25](/images/JPA_ORM/25.jpg)

- 일대다 단방향은 일대다(1:N)에서 **일(1)이 연관관계의 주인**
- 테이블 일대다 관계는 항상 **다(N)쪽에 외래 키가 있음**
- 객체와 테이블의 차이 때문에 반대편 테이블의 외래 키를 관리하는 특이한 구조
- `@JoinColumn`을 꼭 사용해야 함. 그렇지 않으면 조인 테이블 방식을 사용함(중간에 테이블을 추가하는 방식)
    - Ex) TEAM-MEMBER와 같은 테이블을 새로 만들어줌

- 일대다 단방향 매핑의 단점
    - 엔티티가 관리하는 외래 키가 다른 테이블에 있음
    - 연관관계 관리를 위해 추가로 UPDATE SQL 실행
        - 외래 키가 다른 테이블에 있기 때문에 일(1)에서 수정하면 그 컬렉션과 연관된 다(N)의 외래 키 컬럼이 수정되기 때문에 UPDATE SQL이 나간다.
- 일대다 단방향 매핑보다는 **다대일 양방향 매핑을 사용하는 것을 권장**

## 일대다 양방향

![26](/images/JPA_ORM/26.jpg)

- 이런 매핑은 공식적으로 존재X
- `@JoinColumn(name = ..., insertable=false, updatable=false)`
    - 입력, 수정을 차단하는 코드 추가
- **읽기 전용 필드**를 사용해서 양방향 처럼 사용하는 방법
- 그냥 **다대일 양방향을 사용하는 것을 권장**

<br>

# 일대일 [1:1]

## 일대일 관계

- 일대일 관계는 그 반대도 일대일
- 주 테이블이나 대상 테이블 중에 외래 키 선택 가능
    - 둘 중 아무곳이나 상관없다.
- 외래 키에 데이터베이스 유니크(UNI) 제약조건 추가

## 주 테이블에 외래 키(단방향)

![27](/images/JPA_ORM/27.jpg)

- 다대일(@ManyToOne) 단방향 매핑과 유사

## 주 테이블에 외래 키(양방향)

![28](/images/JPA_ORM/28.jpg)

- 다대일 양방향 매핑 처럼 **외래 키가 있는 곳이 연관관계의 주인**
- 반대편은 `mappedBy` 적용

## 대상 테이블에 외래 키(단방향)

![29](/images/JPA_ORM/29.jpg)

- **단방향 관계는 JPA 지원X**
- 양방향 관계는 지원

## 대상 테이블에 외래 키(양방향)

![30](/images/JPA_ORM/30.jpg)

- 일대일 주 테이블에 외래 키 양방향과 매핑 방법은 같다.

### 일대일 정리

- **주 테이블에 외래 키**
    - 주 객체가 대상 객체의 참조를 가지는 것 처럼 주 테이블에 외래 키를 두고 대상 테이블을 찾음
    - 객체지향 개발자가 선호
    - JPA 매핑 편리
    - 장점: 주 테이블만 조회해도 대상 테이블에 데이터가 있는지 확인 가능
    - 단점: 값이 없으면 외래 키에 null 허용
- **대상 테이블에 외래 키**
    - 대상 테이블에 외래 키가 존재
    - 데이터베이스 개발자가 선호
    - 장점: 주 테이블과 대상 테이블을 일대일에서 일대다 관계로 변경할 때 테이블 구조 유지
    - 단점: 프록시 기능의 한계로 **지연 로딩으로 설정해도 항상 즉시 로딩됨**

<br>

# 다대다 [N:M]

> **실무에서는 사용하면 안된다!**

- 관계형 데이터베이스는 정규화된 테이블 2개로 다대다 관계를 표현할 수 없음
- 연결 테이블을 추가해서 일대다, 다대일 관계로 풀어내야 함

![31](/images/JPA_ORM/31.jpg)

- **객체는 컬렉션을 사용해서 객체 2개로 다대다 관계가 가능**

![32](/images/JPA_ORM/32.jpg)

- **@ManyToMany** 사용
- **@JoinTable**로 연결 테이블 지정
- 다대다 매핑: 단방향, 양방향 가능

## 다대다 매핑의 한계

- **편리해 보이지만 실무에서는 사용하면 안된다!**
- 연결 테이블이 단순히 연결만 하고 끝나지 않는다.
- 개발하다 보면 주문시간, 수량 같은 데이터가 들어올 수 있음
- 하지만, 중간 테이블에는 매핑정보만 들어가고, 추가 데이터를 넣는 것이 불가능하다.
- 또한, 중간 테이블이 숨겨져 있기 때문에 나가는 쿼리의 형태를 예상하지 못한다.
- 실무 비즈니스는 복잡해서 `ManyToMany`로 풀 수 있는게 거의 없다.

![33](/images/JPA_ORM/33.jpg)

## 다대다 한계 극복

- **연결 테이블용 엔티티 추가(연결 테이블을 엔티티로 승격)**
- **@ManyToMany -> @OneToMany, @ManyToOne**

![34](/images/JPA_ORM/34.jpg)

<br>

# @JoinColumn

**외래 키를 매핑할 때 사용**

- **name** : 매핑할 외래 키 이름 (기본값 : 필드명 + _ + 참조하는 테이블의 기본 키 컬럼명)
- referencedColumnName : 외래 키가 참조하는 대상 테이블의 컬럼명 (기본값: 참조하는 테이블의 기본 키 컬럼명)
- **foreignKey(DDL)** : 외래 키 제약조건을 직접 지정할 수 있다.
    - 이 속성은 테이블을 생성할 때만 사용한다.
- unique... : @Column의 속성과 같다..

<br>

# @ManyToOne

**다대일 관계 매핑**

- optional : false로 설정하면 연관된 엔티티가 항상 있어야 한다. (기본값 : TRUE)
- fetch : 글로벌 패치 전략을 설정한다.
    - 기본값
    - @ManyToOne = FetchType.EAGER
    - @OneToMany = FetchType.LAZY
- cascade : 영속성 전이 기능을 사용한다.

<br>

# @OneToMany

**일대다 관계 매핑**

- mappedBy : 연관관계의 주인 필드를 선택한다.
- fetch : 글로벌 패치 전략을 설정한다.
    - 기본값
    - @ManyToOne = FetchType.EAGER
    - @OneToMany = FetchType.LAZY
- cascade : 영속성 전이 기능을 사용한다.

<br>

<출처 : [인프런 - 자바 ORM 표준 JPA 프로그래밍 - 기본편 (김영한)](https://www.inflearn.com/course/ORM-JPA-Basic)>