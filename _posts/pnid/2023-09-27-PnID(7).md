---
layout: singledemo
title: "데모 페이지"
permalink: /projects/pnid/07
tag: [Vision AI, Drawing]
header:
  teaser: /assets/images/drawing_recognition_teaser.jpg
author_profile: false
sidebar:
  nav: "docs1"
date: 2023-09-27
---

## 데모 페이지


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Model UI</title>
</head>

<body>
  <div>
    <form action="#">
      백엔드 선택: &nbsp;
      <select id="backend-select">
        <option value="webgl">GPU-WebGL</option>
      </select>
      <br>
      <label>이미지 선택</label>
      <select id="image-url">
        <option value="0">select image</option>
        <option value="pnid01">설계도면01</option>
        <option value="pnid02">설계도면02</option>
      </select>
      <input type="submit" value="Submit" id="upload-image-button" />
    </form>
    <canvas id="canvas" width="416" height="416" style="border:1px solid black;"></canvas>
    <br>
    <div id="predictions"></div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/onnxjs/dist/onnx.min.js"></script>

  <script>
    async function runModel(imageUrl, selectedBackend) {
      document.getElementById('predictions').innerHTML = '';

      const modelFilepath = `../../assets/model/yolo.onnx`;
      const image = new Image();
      image.src = imageUrl;

      image.onload = async function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

        // 이미지 전처리 (예시: 이미지를 0~1 사이 값으로 정규화)
        const inputData = preprocessImage(ctx, canvas);
        console.log('inputData:', inputData);


        // 모델 실행
        const session = new onnx.InferenceSession();
        session.loadModel(modelFilepath).then(() => {
          console.log('YOLO model loaded successfully.');

          // 이미지 로드 및 전처리
          const imageElement = document.getElementById('input-image'); // 입력 이미지 요소
          const imageData = preprocessImage(imageElement); // 이미지 전처리 함수

          // 입력 데이터를 ONNX.js Tensor로 변환
          const inputTensor = new Tensor(new Float32Array(imageData), 'float32', [1, 3, 416, 416]);

          // YOLO 모델 실행
          const outputMap = session.run([inputTensor]);

          // 결과 처리
          const outputTensor = outputMap.values().next().value;
          const predictions = outputTensor.data;

          // 예측 결과 처리 코드 작성
          processPredictions(predictions);
        }).catch((err) => {
          console.error('Error loading YOLO model:', err);
        });
        // const session = new onnx.InferenceSession({ backendHint: selectedBackend, optimizedModel: true });
        // console.log('111');
        // await session.loadModel(modelFilepath);
        // console.log('222');
        // const output = await session.run([inputData]);
        // console.log('333');
        // const predictions = Array.from(output.values())[0].data;
        // console.log('444');

        // // 예측 결과 표시
        // displayPredictions(predictions);
        // console.log('displaypredictions')
      };
    }

    function preprocessImage(ctx, canvas) {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const inputData = new Float32Array(imageData.data).map(v => v / 255);
      const width = canvas.width;
      const height = canvas.height;
      const channels = 3; // RGB 이미지이므로 3개의 채널
      const inputArray = new Float32Array(width * height * channels);
      for (let i = 0; i < inputData.length; i++) {
        // 이미지 데이터를 채널 순서로 재배열합니다. (RGBRGBRGB...)
        const channel = i % channels;
        const rowIndex = Math.floor(i / (channels * width));
        const colIndex = Math.floor((i % (channels * width)) / channels);
        inputArray[channel * width * height + rowIndex * width + colIndex] = inputData[i];
      }
      const tensor = new onnx.Tensor(inputArray, 'float32', [1, channels, height, width]);
      return tensor;
    }

    function displayPredictions(predictions) {
      console.log('555');
      const predictionsDiv = document.getElementById('predictions');
      console.log('666');
      predictionsDiv.innerHTML = '<h2>Predictions:</h2>';
      console.log('777');
      predictionsDiv.innerHTML += '<ul>';
      console.log('888');
      predictions.forEach((prediction, index) => {
        console.log('prediction, index', prediction, index);
        predictionsDiv.innerHTML += `<li>Class ${index}: ${prediction.toFixed(4)}</li>`;
      });
      console.log('999');
      predictionsDiv.innerHTML += '</ul>';
    }

    document.addEventListener('DOMContentLoaded', function() {
      const backendSelect = document.getElementById('backend-select');
      const imageUrlInput = document.getElementById('image-url');
      const runModelButton = document.getElementById('upload-image-button');

      runModelButton.addEventListener('click', function(event) {
        event.preventDefault(); // 폼 제출 방지

        const selectedBackend = backendSelect.value;
        const imageName = imageUrlInput.value;
        if (imageName !== "0") {
          const imagePath = `../../assets/images/2023-09-27-PnID(7)/${imageName}.jpg`;
          console.log('101010');
          runModel(imagePath, selectedBackend);
        }
      });
    });
  </script>
</body>