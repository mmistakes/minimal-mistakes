---
title:  "C++ Chapter 15.7 : ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°3ï¸âƒ£ std::weak_ptr" 

categories:
  - Cpp
tags:
  - [Programming, Cpp]

toc: true
toc_sticky: true

date: 2020-08-10
last_modified_at: 2020-08-10
---

ì¸í”„ëŸ°ì— ìˆëŠ” í™ì •ëª¨ êµìˆ˜ë‹˜ì˜ **í™ì •ëª¨ì˜ ë”°ë¼ í•˜ë©° ë°°ìš°ëŠ” C++** ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ í•„ê¸°ì…ë‹ˆë‹¤. ğŸ˜€    
[ğŸŒœ [í™ì •ëª¨ì˜ ë”°ë¼ í•˜ë©° ë°°ìš°ëŠ” C++]ê°•ì˜ ë“¤ìœ¼ëŸ¬ ê°€ê¸°!](https://www.inflearn.com/course/following-c-plus)
{: .notice--warning}

<br> 

# chapter 15. ì˜ë¯¸ë¡ ì  ì´ë™ê³¼ ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°

# 15.7 ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°3ï¸âƒ£ std::weak_ptr

> #include \<memory>

## ğŸš€ ì°¸ê³ 

![image](https://user-images.githubusercontent.com/42318591/104432818-bac39000-55cc-11eb-82cd-c22ac5bad05b.png)

![image](https://user-images.githubusercontent.com/42318591/104432839-c1ea9e00-55cc-11eb-90ea-a4f4dedf99f1.png)

![image](https://user-images.githubusercontent.com/42318591/104432862-c911ac00-55cc-11eb-86db-7c982fd4ac7c.png)

![image](https://user-images.githubusercontent.com/42318591/104432890-d29b1400-55cc-11eb-9d51-a89c9ba6a11c.png)

![image](https://user-images.githubusercontent.com/42318591/104432921-d9c22200-55cc-11eb-967f-94517aa183c4.png)

![image](https://user-images.githubusercontent.com/42318591/104538668-ab415700-565f-11eb-9d23-5f54279b15e1.png)

ë‚´ê°€ ì“´ ë‹µë³€ì´ë‹¤. [ì´ ë¸”ë¡œê·¸](https://jungwoong.tistory.com/50?category=1102341) ì´ ì´ ë‹µë³€ì„ ì‘ì„±í•˜ëŠ”ë°ì— ë„ì›€ ë˜ì—ˆë‹¤. `std::shared_ptr`ì— ëŒ€í•´ ë” ìì„¸í•œ ê²ƒì€ ë§í¬ ëœ ë¸”ë¡œê·¸ì—ì„œ ì°¸ê³ í•˜ê¸°.

<br>

## ğŸ”” shared_ptrì˜ ìˆœí™˜ ì˜ì¡´ì„± ë¬¸ì œ

```cpp
#include <iostream>
#include <memory>
#include <string>

class Person
{
	std::string m_name;
	std::shared_ptr<Person> m_partner;
	//std::weak_ptr<Person> m_partner;

public:
	Person(const std::string &name) : m_name(name)
	{
		std::cout << m_name << " created\n";
	}

	~Person()
	{
		std::cout << m_name << " destroyed\n";
	}

	friend bool partnerUp (std::shared_ptr<Person> &p1, std::shared_ptr<Person> &p2) // â­â­
	{
		if (!p1 || !p2)
			return false;
		
		p1->m_partner = p2;
		p2->m_partner = p1;

		std::cout << p1->m_name << " is partnered with " << p2->m_name << "\n";

		return true;
	}

	const std::string & getName() const
	{
		return m_name;
	}
};
```

- **partnerUp** í•¨ìˆ˜
  - Person ê°ì²´ë¥¼ ì†Œìœ í•˜ëŠ” ì¸ìˆ˜ë¡œ ë“¤ì–´ì˜¨ shared_ptr ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ë¥¼ ì°¸ì¡°í•˜ëŠ” `p1`ê³¼ `p2`
    - ì„œë¡œë¥¼ ì„œë¡œì˜ íŒŒíŠ¸ë„ˆë¡œ ì§€ì •í•˜ëŠ” ì—­í• ì„ í•˜ëŠ” í•¨ìˆ˜ë‹¤.
      - `p1`ì˜ m_partner ì„ `p2`ë¡œ ì„¤ì •
      - `p2`ì˜ m_partner ì„ `p1`ë¡œ ì„¤ì •
      - **m_partner**ëŠ” `shared_ptr`ì¸ ë©¤ë²„ë‹¤.

> **ìˆœí™˜ ì°¸ì¡°ì„± ë¬¸ì œ** ğŸ‘‰ shared_ptrë¡œ ì„œë¡œê°€ ì„œë¡œë¥¼ ì°¸ì¡°í• ì‹œ <u>ì†Œìœ ê¶Œì´ ìˆœí™˜ì´ ë˜ì„œ ì˜ì›íˆ ë‘ ê°ì²´ë¥¼ delete í•  ìˆ˜ ì—†ëŠ” ë¬¸ì œ.</u>

- ì„œë¡œê°€ ì„œë¡œë¥¼ ê°€ë¦¬í‚¤ëŠ” `shared_ptr`ì„ ê°€ì§€ê³  ìˆë‹¤ë©´ `use_count()` ê°’ì€ ì ˆëŒ€ 0 ì´ ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë©”ëª¨ë¦¬ëŠ” ì˜ì›íˆ í•´ì œ ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒ í•œë‹¤. 

```cpp
int main()
{
	auto lucy = std::make_shared<Person>("Lucy");
	auto ricky = std::make_shared<Person>("Ricky");

	return 0;
}
```
```
ğŸ’ì¶œë ¥ğŸ’

Lucy created
Ricky created
Ricky destroyed
Lucy destroyed
```

- ìœ„ì™€ ê°™ì´ **partnerUp** í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ì„ ë•ŒëŠ”, ì¦‰ ë‘ shared_ptr `lucy`, `ricky`ê°€ ì„œë¡œê°€ ì„œë¡œë¥¼ ì°¸ì¡°í•˜ê³  ìˆì§€ ì•Šì„ ë•ŒëŠ” ë‘˜ ë‹¤ ë¸”ë¡ ë°–ì„ ë²—ì–´ë‚  ë•Œ ì •ìƒì ìœ¼ë¡œ *delete* ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

```cpp
int main()
{
	auto lucy = std::make_shared<Person>("Lucy");
	auto ricky = std::make_shared<Person>("Ricky");
	
	partnerUp(lucy, ricky); // â­â­

	return 0;
}
```
```
ğŸ’ì¶œë ¥ğŸ’

Lucy created
Ricky created
Lucy is partnered with Ricky
```

- ë‘ ì†Œë©¸ìê°€ í˜¸ì¶œ ë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ë³´ì•„ ë‘ Person ê°ì²´ê°€ <u>delete ë˜ì§€ ì•Šì€ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.</u>
  - **partnerUp í•¨ìˆ˜ë¡œ ì¸í•˜ì—¬ ì„œë¡œë¥¼ ì°¸ì¡°í•˜ê²Œ ëœ ê²ƒì´ ë¬¸ì œ.**
    - "Lucy" ê°ì²´ì— ëŒ€í•œ ì†Œìœ ê¶Œì€ `lucy`, `ricky` ë‘˜ ë‹¤ ê°€ì§€ê³  ìˆê²Œ ë¨
    - "Ricky" ê°ì²´ì— ëŒ€í•œ ì†Œìœ ê¶Œì€ `lucy`, `ricky` ë‘˜ ë‹¤ ê°€ì§€ê³  ìˆê²Œ ë¨
- ë¸”ë¡ ë°–ì„ ë²—ì–´ë‚˜ê±°ë‚˜ í”„ë¡œê·¸ë¨ ì¢…ë£Œì‹œ
  - `auto lucy = std::make_shared<Person>("Lucy")` ê°€ ì†Œë©¸ ë˜ë ¤ê³  í•  ë•Œ
    - ğŸ‘‰ "Lucy"ì— ëŒ€í•œ ì†Œìœ ê¶Œì´ rickyì—ê²Œë„ ìˆìœ¼ë¯€ë¡œ ì•„ì§ ì†Œìœ í•˜ê³  ìˆëŠ” í¬ì¸í„°ê°€ ë‚¨ì•„ ìˆìœ¼ë¯€ë¡œ "Lucy" ê°ì²´ëŠ” delete ë˜ì§€ ì•ŠìŒ.
  - `auto ricky = std::make_shared<Person>("Ricky")`  ê°€ ì†Œë©¸ ë˜ë ¤ê³  í•  ë•Œ.
    - ğŸ‘‰ "Ricky"ì— ëŒ€í•œ ì†Œìœ ê¶Œì´ lucyì—ê²Œë„ ìˆìœ¼ë¯€ë¡œ 
    ì•„ì§ ì†Œìœ í•˜ê³  ìˆëŠ” í¬ì¸í„°ê°€ ë‚¨ì•„ ìˆìœ¼ë¯€ë¡œ "Ricky" ê°ì²´ëŠ” delete ë˜ì§€ ì•ŠìŒ. 
  - ì´ë ‡ê²Œ ì˜ì›íˆ ì°¸ì¡° ê°œìˆ˜ê°€ 0 ì´ ë  ìˆ˜ ì—†ì–´ì„œ ì´ëŸ¬ì§€ë„ ì €ëŸ¬ì§€ë„ ëª»í•˜ëŠ” ìƒí™©ì´ ëœë‹¤.

<br>

## ğŸ”” std::weak_ptr 

> shared_ptrì˜ ìˆœí™˜ ì˜ì¡´ì„± ë¬¸ì œë¥¼ í•´ê²°í•´ì¤€ë‹¤.

```cpp
#include <iostream>
#include <memory>
#include <string>

class Person
{
	std::string m_name;
	
	//std::shared_ptr<Person> m_partner;
	std::weak_ptr<Person> m_partner;

public:
	Person(const std::string &name) : m_name(name)
	{
		std::cout << m_name << " created\n";
	}

	~Person()
	{
		std::cout << m_name << " destroyed\n";
	}

	friend bool partnerUp(std::shared_ptr<Person> &p1, std::shared_ptr<Person> &p2)
	{
		if (!p1 || !p2)
			return false;
		
		p1->m_partner = p2;
		p2->m_partner = p1;

		std::cout << p1->m_name << " is partnered with " << p2->m_name << "\n";

		return true;
	}

	const std::string & getName() const
	{
		return m_name;
	}
};
```
```cpp
int main()
{
	auto lucy = std::make_shared<Person>("Lucy");
	auto ricky = std::make_shared<Person>("Ricky");
	
	partnerUp(lucy, ricky);

	return 0;
}
```
```
ğŸ’ì¶œë ¥ğŸ’

Lucy created
Ricky created
Lucy is partnered with Ricky
Ricky destroyed
Lucy destroyed
```

- **m_partner**ë¥¼ shared_ptr ì—ì„œ `weak_ptr`ë¡œ ë°”ê¿”ì£¼ë‹ˆ ìˆœí™˜ ì°¸ì¡° ë¬¸ì œê°€ ì œê±° ë˜ì—ˆë‹¤. <u>ë‘ ê°ì²´ê°€ ì˜ delete ëœ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.</u>
  ```cpp
  std::weak_ptr<Person> m_partner;
  ```
- `weak_ptr`
  - <u>í•˜ë‚˜ ì´ìƒì˜ shared_ptr</u> ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ê°€ ì†Œìœ í•˜ëŠ” ê°ì²´ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œê³µí•˜ì§€ë§Œ <u>ì†Œìœ ìì˜ ìˆ˜ì—ëŠ” í¬í•¨ë˜ì§€ ì•ŠëŠ”ë‹¤. ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ì— í¬í•¨ë˜ì§€ ì•ŠëŠ”ë‹¤.</u>
  - ì¼ë°˜ í¬ì¸í„°ì™€ shared_ptr ì‚¬ì´ì— ìœ„ì¹˜í•œ ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ì´ë‹¤.
    - ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ì²˜ëŸ¼ ìë™ìœ¼ë¡œ deleteë„ í•´ì£¼ê³  ê°ì²´ë¥¼ ì•ˆì „í•˜ê²Œ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì§€ë§Œ
    - <u>shared_ptrê³¼ ë‹¬ë¦¬ ì°¸ì¡° ê°œìˆ˜ë¥¼ ëŠ˜ë¦¬ì§€ ì•ŠëŠ”ë‹¤.</u>
      - ë”°ë¼ì„œ ìœ„ì˜ ì˜ˆì œì—ì„œ **m_partner**ëŠ” `weak_ptr`ì´ë¯€ë¡œ ì¹´ìš´íŠ¸ì— ì„¸ì§€ ì•Šê¸° ë•Œë¬¸ì— 2 ê°œê°€ ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ 1 ê°œë¡œ ìœ ì§€í•˜ê²Œ ëœë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë‚˜ì¤‘ì— ë¸”ë¡ ë°–ì„ ë²—ì–´ë‚ ì‹œ 0 ê°œê°€ ë˜ì–´ ì„±ê³µì ìœ¼ë¡œ ë‘ ê°ì²´ê°€ *delete* ë  ìˆ˜ ìˆê²Œ ëœ ê²ƒì´ë‹¤.
      - ğŸ‘‰ ì•½í•œ ì°¸ì¡°
- **partnerUp** í•¨ìˆ˜ì˜ ê²°ê³¼ë¡œ
  - `lucy`ëŠ” "Lucy" ê°ì²´ë¥¼ ê°•í•˜ê²Œ ì°¸ì¡°í•˜ì§€ë§Œ "Ricky"ëŠ” ì•½í•˜ê²Œ ì°¸ì¡°í•œë‹¤. (ğŸ‘‰ ê³µìœ í•˜ëŠ” ê°ì²´ë¡œ ì¹´ìš´íŠ¸ ë˜ì§„ ì•ŠëŠ”ë‹¤.)
  - `ricky`ëŠ” "Ricky" ê°ì²´ë¥¼ ê°•í•˜ê²Œ ì°¸ì¡°í•˜ì§€ë§Œ "Lucy"ëŠ” ì•½í•˜ê²Œ ì°¸ì¡°í•œë‹¤. (ğŸ‘‰ ê³µìœ í•˜ëŠ” ê°ì²´ë¡œ ì¹´ìš´íŠ¸ ë˜ì§„ ì•ŠëŠ”ë‹¤.)

<br>

### ì£¼ì˜í•  ì 

> `weak_ptr` ìì²´ë¡œëŠ” ì†Œìœ í•˜ê³  ìˆëŠ” ê°ì²´ì˜ ë©¤ë²„ë‚˜ í¬ì¸í„°ì— ì ‘ê·¼í•  ìˆ˜ ì—†ì–´ì„œ ê·¸ëŸ¬ê¸° ìœ„í•´ì„  ë°˜ë“œì‹œ `shared_ptr`ë¡œ ë³€í™˜í•´ì„œ ì‚¬ìš©í•˜ì—¬ì•¼ í•œë‹¤. ğŸ‘ˆ **lock í•¨ìˆ˜ë¥¼ í†µí•˜ì—¬ ì‹¤í˜„**

<u>weak_ptrì€ ì˜¤ì§ shared_ptrì´ë‚˜ weak_ptrë§Œ ëŒ€ì… ë° í• ë‹¹ ë°›ì„ ìˆ˜ ìˆë‹¤. weak_ptrì—” ì§ì ‘ì ì¸ ë°ì´í„°ì˜ ì£¼ì†Œë¥¼ ëŒ€ì…í•  ìˆ˜ ì—†ë‹¤.</u> ë³µì‚¬ ìƒì„±ì, ëŒ€ì… ì—°ì‚°ì ì˜¤ë²„ë¡œë”©ë„ shared_ptrì´ë‚˜ weak_ptrë§Œ íŒŒë¼ë¯¸í„°ë¡œ ë°›ê²Œë” ë‚´ë¶€ì ìœ¼ë¡œ êµ¬í˜„ì´ ë˜ì–´ ìˆìŒ. ê·¸ë¦¬ê³  ì§ì ‘ì ì¸ ë°ì´í„°ëŠ” *lock* í•¨ìˆ˜ `shared_ptr`ì„ ë¦¬í„´ ë°›ì•„ì„œ ë˜ ì´ë¥¼ í†µí•´ ë‘ ë‹¤ë¦¬ ê±´ë„ˆ ì ‘ê·¼í•´ì•¼ í•œë‹¤.

```c#
weak_ptr<Person> m_partner = 
```

#### lock í•¨ìˆ˜

- `weak_ptr` ìì²´ ì•ˆì—ì„œ ì •ì˜ê°€ ë˜ì–´ ìˆë‹¤.
- `weak_ptr`ì´ ê°€ë¦¬í‚¤ëŠ” ê°ì²´ê°€ ì•„ì§ ë©”ëª¨ë¦¬ì— ì‚´ì•„ìˆë‹¤ë©´
  - *í•´ë‹¹ ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ëŠ”* `shared_ptr`ì„ ë¦¬í„´í•œë‹¤.
- `weak_ptr`ì´ ê°€ë¦¬í‚¤ëŠ” ê°ì²´ê°€ ì´ë¯¸ ë©”ëª¨ë¦¬ì—ì„œ í•´ì œë˜ì—ˆë‹¤ë©´
  - *ì•„ë¬´ê²ƒë„ ê°€ë¦¬í‚¤ì§€ ì•ŠëŠ”* `shared_ptr`ì„ ë¦¬í„´í•œë‹¤.

```cpp
#include <iostream>
#include <memory>
#include <string>

class Person
{
	std::string m_name;
	
	//std::shared_ptr<Person> m_partner;
	std::weak_ptr<Person> m_partner; // â­â­â­

public:
	Person(const std::string &name) : m_name(name)
	{
		std::cout << m_name << " created\n";
	}

	~Person()
	{
		std::cout << m_name << " destroyed\n";
	}

	friend bool partnerUp(std::shared_ptr<Person> &p1, std::shared_ptr<Person> &p2)
	{
		if (!p1 || !p2)
			return false;
		
		p1->m_partner = p2;
		p2->m_partner = p1;

		std::cout << p1->m_name << " is partnered with " << p2->m_name << "\n";

		return true;
	}

	const std::shared_ptr<Person> getPartner() const // â­â­â­
	{                                            
		return m_partner.lock(); // â­â­ lock í•¨ìˆ˜ ì‹¤í–‰
	}                                            

	const std::string & getName() const
	{
		return m_name;
	}
};

int main()
{
	auto lucy = std::make_shared<Person>("Lucy");
	auto ricky = std::make_shared<Person>("Ricky");
	
	partnerUp(lucy, ricky);

	return 0;
}
```
```cpp
int main()
{
	auto lucy = std::make_shared<Person>("Lucy");
	auto ricky = std::make_shared<Person>("Ricky");
	
	partnerUp(lucy, ricky);

	std::cout << lucy->getPartner()->getName() << std::endl; // Ricky ì¶œë ¥

	return 0;
}
```
```
ğŸ’ì¶œë ¥ğŸ’

Lucy created
Ricky created
Lucy is partnered with Ricky
Ricky
Ricky destroyed
Lucy destroyed
```

- `lucy->getPartner()->getName()`
  - ***getPartner***í•¨ìˆ˜ì˜ **return m_partner.**`lock()`
    - `weak_ptr`ì¸ **m_partner**ì˜ `lock()`í•¨ìˆ˜ í˜¸ì¶œ
  - `lucy`ê°€ ì†Œìœ í•˜ëŠ” ê°ì²´ì˜ ë©¤ë²„ì¸ `m_partner`ëŠ” í˜„ì¬ ì†Œìœ í•˜ê³  ìˆëŠ” ê°ì²´ `ricky`ê°€ ìˆë‹¤. 
    - ë”°ë¼ì„œ `lock()`í•¨ìˆ˜ëŠ” ì´ë¥¼ `shared_ptr`ë¡œì„œ ì„ì‹œ ë³€í™˜ë˜ì–´ ë¦¬í„´í•œë‹¤.
      - âœ¨`weak_ptr`ë¡œëŠ” <u>ì†Œìœ í•˜ê³  ìˆëŠ” ê°ì²´ì˜ ë©¤ë²„ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥ í•œë°</u> `lucy->getPartner()` ì´ë ‡ê²Œ shared_ptrë¡œì„œ ë¦¬í„´ë˜ì–´ `getName()` ë©¤ë²„ í•¨ìˆ˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤. 
- í¬ì¸í„°ë¡œ ì ‘ê·¼í•˜ë ¤ë©´ shared_ptrë¡œ ë³€í™˜ëœ í›„ `get()` í•¨ìˆ˜ë¥¼ ê±°ì³ì•¼ í•œë‹¤.

***
<br>

    ğŸŒœ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ í‹€ë¦° ë¶€ë¶„ì´ ìˆì„ ê²½ìš° 
    ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ì§€ì í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}
<br>