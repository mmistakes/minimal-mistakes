---
title:  "Chapter 3. ë¹„ë™ê¸° I/O ë°©ì‹ì˜ TCP/IP Echo ì„œë²„, í´ë¼ì´ì–¸íŠ¸" 

categories:
  -  Cpp Network 
tags:
  - [Cpp, Programming, Network]

toc: true
toc_sticky: true

date: 2020-09-05
last_modified_at: 2020-09-05
---

ìµœí¥ë°°ë‹˜ì˜ ì±… **Boost.Asioë¥¼ ì‚¬ìš©í•œ ë„¤íŠ¸ì›Œí¬ í”„ë¡œê·¸ë˜ë°** ì„ ê³µë¶€í•˜ê³  ì •ë¦¬í•œ í•„ê¸°ì…ë‹ˆë‹¤. ğŸ˜€  
{: .notice--warning}


# Chapter 3. ë¹„ë™ê¸° I/O ë°©ì‹ì˜ TCP/IP Echo ì„œë²„, í´ë¼ì´ì–¸íŠ¸ í”„ë¡œê·¸ë¨ ë§Œë“¤ê¸°

## ğŸ”” ë¹„ë™ê¸° I/O í”„ë¡œê·¸ë˜ë°ì˜ íŠ¹ì§•

> A ë¼ëŠ” ì‘ì—…ì„ ìš”ì²­í•˜ë©´ A ì‘ì—…ì´ ì™„ë£Œë ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë‹¤ìŒ ì‘ì—…ì„ ì§„í–‰í•˜ë‹¤ê°€ A ì‘ì—…ì´ ëë‚˜ë©´ ë‹¤ì‹œ ëŒì•„ì™€ A ì˜ ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ì‹ì´ë‹¤.

- ì‘ì—… íë¦„ì— ëŒ€ê¸°ê°€ ì—†ì´ ì‹ ì†í•˜ê³  íš¨ìœ¨ì ìœ¼ë¡œ ì‘ì—…ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
- ë¹„ë™ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ì—ëŠ” ì•ì— `async`ì„ í‘œê¸°í•œë‹¤.
  ```
  async_ë•¡ë•¡ (ìš”ì²­ ì‘ì—…ì— ì‚¬ìš©í•  ì¸ìˆ˜, ìš”ì²­í•œ ì‘ì—…ì´ ëë‚˜ë©´ í˜¸ì¶œí•  í•¨ìˆ˜ í¬ì¸í„°)
  ```
  - ì˜ˆë¥¼ ë“¤ì–´ ì•„ë˜ì™€ ê°™ì€ ê²½ìš° ë°ì´í„°ë¥¼ ì½ëŠ” `async_read` í•¨ìˆ˜ëŠ” ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ì´ ëœë‹¤. `async_read` í•¨ìˆ˜ë¥¼ ì²˜ë¦¬í•˜ëŠ”ë° `Buffer` ì¸ìˆ˜ê°€ í•„ìš”í•˜ë©° (ì½ì€ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë‹´ëŠ”ë‹¤) ê·¸ë¦¬ê³  í•¨ìˆ˜ ì‹¤í–‰ì´ ëë‚˜ë©´ `Session::OnRead` ë©¤ë²„ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤. 
  - <u>`async_read` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ì´ í•¨ìˆ˜ ì‹¤í–‰ì´ ëë‚  ë•Œ ê¹Œì§€ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë‹¤ë¥¸ ì‘ì—…ì„ í•˜ëŸ¬ ê°„ë‹¤.</u> <u>ë‹¤ë¥¸ ì‘ì—…ì„ í•˜ë˜ ë„ì¤‘ `async_read` í•¨ìˆ˜ ì‘ì—…ì´ ì™„ë£Œë˜ë©´ `Session::OnRead` ë©¤ë²„ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œë‹¤.</u>
    ```cpp
    async_read(Buffer, Session::OnRead)
    ```

<br>

## ğŸ”” ì„œë²„

```cpp
#include <SDKDDKVer.h>
#include <iostream>
#include <algorithm>
#include <string>
#include <list>
#include <boost/bind.hpp>
#include <boost/asio.hpp>



class Session
{
private:
	boost::asio::ip::tcp::socket m_Socket;
	std::string m_WriteMessage;
	std::array<char, 128> m_ReceiveBuffer;

public:
	Session(boost::asio::io_service& io_service)
		: m_Socket(io_service)
	{
	}

	boost::asio::ip::tcp::socket& Socket()
	{
		return m_Socket;
	}

	void PostReceive()
	{
		memset(&m_ReceiveBuffer, '\0', sizeof(m_ReceiveBuffer));

		m_Socket.async_read_some
		(boost::asio::buffer(m_ReceiveBuffer), boost::bind(&Session::handle_receive, this, boost::asio::placeholders::error, boost::asio::placeholders::bytes_transferred));

	}


private:
	void handle_write(const boost::system::error_code& /*error*/, size_t /*bytes_transferred*/)
	{}

	void handle_receive(const boost::system::error_code& error, size_t bytes_transferred)
	{
		if (error)
		{
			if (error == boost::asio::error::eof)
				std::cout << "í´ë¼ì´ì–¸íŠ¸ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤" << std::endl;
			else
				std::cout << "error No: " << error.value() << " error Message: " << error.message() << std::endl;
		}
		else
		{
			const std::string strRecvMessage = m_ReceiveBuffer.data();
			std::cout << "í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì€ ë©”ì‹œì§€: " << strRecvMessage << ", ë°›ì€ í¬ê¸°: " << bytes_transferred << std::endl;

			char szMessage[128] = { 0, };
			sprintf_s(szMessage, 128 - 1, "Re:%s", strRecvMessage.c_str());
			m_WriteMessage = szMessage;

			boost::asio::async_write(m_Socket, boost::asio::buffer(m_WriteMessage),boost::bind(&Session::handle_write, this, boost::asio::placeholders::error, boost::asio::placeholders::bytes_transferred));

			PostReceive();
		}
	}
};

const unsigned short PORT_NUMBER = 31400;

class TCP_Server
{
private:
	int m_nSeqNumber;
	boost::asio::ip::tcp::acceptor m_acceptor;
	boost::asio::io_service& m_io_service;
	Session* m_pSession;

public:
	TCP_Server(boost::asio::io_service& io_service)
		: m_io_service(io_service), m_acceptor(io_service, boost::asio::ip::tcp::endpoint(boost::asio::ip::tcp::v4(), PORT_NUMBER))
	{
		m_pSession = nullptr;
		StartAccept();
	}

	~TCP_Server()
	{
		if (m_pSession != nullptr)
			delete m_pSession;
	}

private:
	void StartAccept()
	{
		std::cout << "í´ë¼ì´ì–¸íŠ¸ ì ‘ì† ëŒ€ê¸°....." << std::endl;

		m_pSession = new Session(m_io_service);

		m_acceptor.async_accept(m_pSession->Socket(), boost::bind(&TCP_Server::handle_accept, this, m_pSession, boost::asio::placeholders::error));
	}

	void handle_accept(Session* pSession, const boost::system::error_code& error)
	{
		if (!error)
		{
			std::cout << "í´ë¼ì´ì–¸íŠ¸ ì ‘ì† ì„±ê³µ" << std::endl;

			pSession->PostReceive();
		}
	}
};

int main()
{
	boost::asio::io_service io_service;

	TCP_Server server(io_service);

	io_service.run();


	std::cout << "ë„¤íŠ¸ì› ì ‘ì† ì¢…ë£Œ" << std::endl;

	getchar();
	return 0;
}
```

<br>

## ğŸ”” í´ë¼ì´ì–¸íŠ¸

```cpp
#include <SDKDDKVer.h>
#include <iostream>
#include <boost/bind.hpp>
#include <boost/asio.hpp>


const char SERVER_IP[] = "127.0.0.1";
const unsigned short PORT_NUMBER = 31400;


class TCP_Client
{
private:
	boost::asio::io_service& m_io_service;
	boost::asio::ip::tcp::socket m_Socket;

	int m_nSeqNumber;
	std::array<char, 128> m_ReceiveBuffer;
	std::string m_WriteMessage;

public:
	TCP_Client(boost::asio::io_service& io_service)
		: m_io_service(io_service),
		m_Socket(io_service),
		m_nSeqNumber(0)
	{}

	void Connect(boost::asio::ip::tcp::endpoint& endpoint)
	{
		m_Socket.async_connect(endpoint,
			boost::bind(&TCP_Client::handle_connect, this, boost::asio::placeholders::error));
	}


private:
	void PostWrite()
	{
		if (m_Socket.is_open() == false)
			return;

		if (m_nSeqNumber > 7)
		{
			m_Socket.close();
			return;
		}


		++m_nSeqNumber;

		char szMessage[128] = { 0, };
		sprintf_s(szMessage, 128 - 1, "%d - Send Message", m_nSeqNumber);

		m_WriteMessage = szMessage;

		boost::asio::async_write(m_Socket, boost::asio::buffer(m_WriteMessage), boost::bind(&TCP_Client::handle_write, this, boost::asio::placeholders::error, boost::asio::placeholders::bytes_transferred));

		PostReceive();
	}

	void PostReceive()
	{
		memset(&m_ReceiveBuffer, '\0', sizeof(m_ReceiveBuffer));

		m_Socket.async_read_some(boost::asio::buffer(m_ReceiveBuffer), boost::bind(&TCP_Client::handle_receive, this, boost::asio::placeholders::error, boost::asio::placeholders::bytes_transferred));

	}


	void handle_connect(const boost::system::error_code& error)
	{
		if (error)
			std::cout << "connect failed : " << error.message() << std::endl;
		else
		{
			std::cout << "connected" << std::endl;

			PostWrite();
		}
	}

	void handle_write(const boost::system::error_code& /*error*/, size_t /*bytes_transferred*/)
	{}

	void handle_receive(const boost::system::error_code& error, size_t bytes_transferred)
	{
		if (error)
		{
			if (error == boost::asio::error::eof)
				std::cout << "ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤" << std::endl;
			else
				std::cout << "error No: " << error.value() << " error Message: " << error.message() << std::endl;
		}
		else
		{
			const std::string strRecvMessage = m_ReceiveBuffer.data();
			std::cout << "ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€: " << strRecvMessage << ", ë°›ì€ í¬ê¸°: " << bytes_transferred << std::endl;

			PostWrite();
		}
	}
};



int main()
{
	boost::asio::io_service io_service;

	boost::asio::ip::tcp::endpoint endpoint(boost::asio::ip::address::from_string(SERVER_IP), PORT_NUMBER);

	TCP_Client client(io_service);

	client.Connect(endpoint);

	io_service.run();


	std::cout << "ë„¤íŠ¸ì› ì ‘ì† ì¢…ë£Œ" << std::endl;

	getchar();
	return 0;
}

```

<br>

## ğŸ”” ì „ë°˜ì ì¸ íë¦„ : ì„œë²„-í´ë¼ì´ì–¸íŠ¸

![image](https://user-images.githubusercontent.com/42318591/92299518-e33bdd80-ef8d-11ea-9f77-5c9215921a2b.png){: width="70%" height="70%"}{: .align-center}


***
<br>

    ğŸŒœ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ í‹€ë¦° ë¶€ë¶„ì´ ìˆì„ ê²½ìš° 
    ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ì§€ì í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}