---
layout: single
title:  "[Spring Web-MVC] 멀티 쓰레드"
categories: Web-MVC
tag: [web, spring boot, spring mvc, server]
toc: true
toc_sticky: true
author_profile: false
sidebar:
    nav: "docs"
---

<br>

# 쓰레드

- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것이 쓰레드.
- 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행
- 쓰레드가 없다면 자바 애플리케이션 실행이 불가능
- 쓰레드는 한번에 하나의 코드 라인만 수행
- 동시 처리가 필요하면 쓰레드를 추가로 생성

## 단일 요청 - 쓰레드 하나 사용

![thread1](/images/mvc3/thread1.jpg)

### 문제점

- 요청1 처리중에 처리가 지연될 수 있다.
- 처리가 지연될때 요청2를 쓰레드에 연결하려고 하면 연결이 지연되거나, 거부 당하게 된다.

## 요청 마다 쓰레드 생성

![thread2](/images/mvc3/thread2.jpg)

### 장단점

- 장점
    - 동시 요청을 처리할 수 있다.
    - 리소스(CPU, 메모리)가 허용할 때 까지 처리 가능
    - 하나의 쓰레드가 지연 되어도, 나머지 쓰레드는 정상 동작
- 단점
    - 쓰레드는 생성 비용이 매우 비싸다.
    - 고객 요청이 올 때 마다 생성하면 응답 속도가 늦어진다.
    - 쓰레드는 컨텍스트 스위칭 비용이 발생한다.
    - 쓰레드 생성에 제한이 없다.
        - 요청이 너무 많이 오면 CPU, 메모리 임계점을 넘어서 서버가 다운될 수 있다.

<br>

# 쓰레드 풀

**풀장에 모여있는 쓰레드를 연상**<br>
![threadPool](/images/mvc3/threadPool.jpg)

**요청 마다 쓰레드 생성의 단점 보완**

- 특징
    - 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.
    - 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 톰캣은 기본 200개 설정 (변경 가능)
- 사용
    - 쓰레드가 필요하면 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용.
    - **사용을 종료하면 쓰레드 풀에 반납.**
    - 쓰레드가 모두 사용중이라면?
        - 기다리는 요청은 거절하거나 특정 숫자만큼만 대기하도록 설정할 수 있다.
- 장점
    - 쓰레드가 미리 생성되어 있으므로 쓰레드를 생성하고 종료하는 비용(CPU)이 절약되고, 응답 시간이 빠르다.
    - 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 안전하게 처리할 수 있다.

## 실무 팁

- WAS의 주요 튜닝 포인트는 **최대 쓰레드(max thread)수**이다.
- 이 값을 너무 낮게 설정한다면...
    - 동시 요청이 많으면 서버 리소스는 여유롭지만, 클라이언트는 금방 응답 지연
- 이 값을 너무 높게 설정한다면...
    - 동시 요청이 많으면 CPU, 메모리 리소스 임계점 초과로 서버 다운
- 장애 발생시..
    - 클라우드면 일단 서버부터 늘리고, 이후에 튜닝

## 쓰레드 풀의 적정 숫자

- 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다르다.
- 성능 테스트
    - 툴 : 아파치 ab, 제이미터, nGrinder

<br>

# WAS의 멀티 쓰레드 지원

- 멀티 쓰레드에 대한 부분은 WAS가 처리
- 따라서 **개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 된다.**
- 개발자는 **싱글 쓰레드 프로그래밍을 하듯이 편리하게 소스 코드를 개발**
- 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용


<br>

<출처 : [인프런 - 스프링 MVC 1편 : 백엔드 웹 개발 핵심 기술(김영한)](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1)>